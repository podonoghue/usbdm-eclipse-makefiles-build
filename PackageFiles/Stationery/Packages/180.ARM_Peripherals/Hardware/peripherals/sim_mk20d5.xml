<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE peripheralPage SYSTEM "_menu.dtd" >
<!-- sim_mk20d5.xml -->

<peripheralPage xmlns:xi="http://www.w3.org/2001/XInclude" name="_instance" description="SIM">
    
   <xi:include href="_default_instance.xml"/>

   <xi:include href="_sim_rtc_independent.xml"/>
   
   <intOption name="system_usb_clkin_clock"  
      constant="true" 
      hidden="true"
      origin="USB Clock In pin"
      units="Hz"
      description="Frequency of External USB Clock"
      toolTip="Externally provided clock for USB on USB_CLKIN" 
      value="48000000" />

   <choiceOption name="adc_cfg1_adiclk" description="ADC Clock Source"
      toolTip="Clock source for the ADC module"
      hidden="true" >
      <choice value="0" name="Bus clock"                   data="Bus#SystemBusClock"                  />
      <choice value="1" name="Bus clock/2"                 data="Busdiv2#SystemBusClock/2"            />
      <choice value="2" name="Alternate clock (OSCERCLK)"  data="OscerClk#Osc0Info::getOscerClock()"  />
      <choice value="3" name="Asynchronous clock (ADACK)"  data="Asynch#2000000"                      isDefault="true" />
   </choiceOption>
   
   <category name="SOPT1" description="RTC clocks" >

      <aliasOption key="sim_sopt1_osc32ksel" constant="false" />
      <aliasOption key="system_erclk32k_clock" />
      
      <choiceOption name="sim_sopt1_usbpower" 
         description="USB voltage regulator power control"
         toolTip="Controls when the USB voltage regulator is enabled in\n
        (RUN), (STOP, VLPS, LLS and VLLS) or (VLPR and VLPW) modes">
         <choice value="SIM_SOPT1_USBREGEN(0)|SIM_SOPT1_USBSSTBY(0)|SIM_SOPT1_USBVSTBY(0)"  name="Disabled in all modes"         data="Disabled"               />
         <choice value="SIM_SOPT1_USBREGEN(1)|SIM_SOPT1_USBSSTBY(0)|SIM_SOPT1_USBVSTBY(0)"  name="Enabled in all modes"          data="EnabledInAll"           isDefault="true" />
         <choice value="SIM_SOPT1_USBREGEN(1)|SIM_SOPT1_USBSSTBY(1)|SIM_SOPT1_USBVSTBY(0)"  name="Enabled in run and low power"  data="EnabledInRun_LowPower"  />
         <choice value="SIM_SOPT1_USBREGEN(1)|SIM_SOPT1_USBSSTBY(0)|SIM_SOPT1_USBVSTBY(1)"  name="Enabled in run and stop"       data="EnabledInRun_Stop"      />
         <choice value="SIM_SOPT1_USBREGEN(1)|SIM_SOPT1_USBSSTBY(1)|SIM_SOPT1_USBVSTBY(1)"  name="Enabled in run only"           data="EnabledInRun"           />
      </choiceOption>

   </category>

   <category name="SOPT2" description="Clock Gating">
   
      <aliasOption key="/SIM/sim_sopt2_rtcclkoutsel" constant="false"/>
      <aliasOption key="/SIM/rtc_clkout" />
      
      <aliasOption key="/SIM/sim_sopt2_pllfllsel." constant="false" />
      <aliasOption key="/SIM/system_peripheral_clock." optional="true" />

      <aliasOption key="/SIM/sim_sopt2_usbsrc." constant="false" />
      <aliasOption key="/SIM/system_usbfs_clock." />

      <aliasOption key="/OSC0/oscer_clock" optional="true" />
      <aliasOption key="/MCG/system_mcgirclk_clock." optional="true" />
      
      <for keys="n,data,value"
         values="0,SystemCoreClock,system_core_clock;1,SystemCoreClock,system_core_clock;2,SystemBusClock,system_bus_clock" >
         
         <stringOption name="system_uart%(n)_fixedclocksource" 
            constant="true"
            derived="true"
            description="UART%(n) Clock source"
            toolTip="Fixed clock source for UART"
            data="%(data)" 
            value="%(value)" />
      
         <intOption name="system_uart%(n)_clock" 
            constant="true"
            derived="true"
            units="Hz"
            description="UART%(n) Clock frequency"
            toolTip="Frequency of clock to UART"
            value="0" />
      </for>
      
      <binaryOption name="sim_sopt2_ptd7pad" 
         description="PTD7 pad drive strength"
         toolTip="Controls the output drive strength of the PTD7 pin\n
                  by selecting either one or two pads to drive it." >
         <choice value="0"  name="Single-pad drive strength" data="Single" isDefault="true" />
         <choice value="1"  name="Double-pad drive strength" data="Double" />
      </binaryOption>   
      
      <choiceOption name="sim_sopt2_clkoutsel" 
         description="CLKOUT pin clock"
         toolTip="Clock to output on the CLKOUT pin." >
         <choice value="2"  name="Flash clock"         data="FlashClk" isDefault="true" />
         <choice value="3"  name="LPO clock (1 kHz)"   data="LpoClk"       />
         <choice value="4"  name="MCGIRCLK"            data="McgIrClk"     />
         <choice value="5"  name="RTC 32.768kHz clock" data="RtcClk"       />
         <choice value="6"  name="OSCERCLK0"           data="OscerClk0"    />
      </choiceOption>
      
      <binaryOption name="sim_sopt2_traceclksel" 
         description="Debug trace clock select"
         toolTip="Selects the core/system clock or MCG output clock (MCGOUTCLK)\n
             as the trace clock source" >
         <choice value="0"  name="MCGOUTCLK"          data="McgOutClk"  isDefault="true" />
         <choice value="1"  name="Core/system clock"  data="CoreClk"    />
      </binaryOption>   
   </category>
   
   <category name="SOPT4" description="FTM signals">
      
      <binaryOption name="sim_sopt4_ftm0trg0src" 
         description="FTM0 Hardware Trigger 0 Source Select"
         toolTip="Source of FTM hardware trigger 0" >
         <choice value="0"  name="CMP0 output"        data="Cmp0" isDefault="true" />
         <choice value="1"  name="FTM1 channel match" data="Ftm1" />
      </binaryOption>
      <binaryOption name="sim_sopt4_ftm0clksel" 
         description="FTM0 External Clock Pin"
         toolTip="External pin used to drive the clock to the FTM module.">
         <choice value="0"  name="FTM_CLKIN0 pin" data="0" isDefault="true" />
         <choice value="1"  name="FTM_CLKIN1 pin" data="1" />
      </binaryOption>
      
      <binaryOption name="sim_sopt4_ftm1clksel" 
         description="FTM 1 External Clock Pin"
         toolTip="External pin used to drive the clock to the FTM module.">
         <choice value="0"  name="FTM_CLKIN0 pin" data="0" isDefault="true" />
         <choice value="1"  name="FTM_CLKIN1 pin" data="1" />
      </binaryOption>
      
      <choiceOption name="sim_sopt4_ftm1ch0src" 
         description="FTM 1 channel 0 input capture source"
         toolTip="Source for FTM channel 0 input capture\n
            NOTE: When the FTM is not in input capture mode, clear this field">
         <choice value="0" name="FTM1_CH0 signal"          data="IcPin"  isDefault="true"/>
         <choice value="1" name="CMP0 output"              data="Cmp0"     />
         <choice value="2" name="CMP1 output"              data="Cmp1"     />
         <choice value="3" name="USB start of frame pulse" data="UsbSof"   />
      </choiceOption>
      

      <for keys="ftmNum" values="0;1">
         <binaryOption name="sim_sopt4_ftm%(ftmNum)flt0" 
            description="FTM%(ftmNum) Fault 0 Select"
            toolTip="Source of FTM fault input 0" >
            <choice value="0"  name="FTM%(ftmNum)_FLT0 pin" data="Ftm%(ftmNum)Fault0" isDefault="true" />
            <choice value="1"  name="CMP0 output"   data="Cmp0" />
         </binaryOption>
      </for>
      <for keys="ftmNum" values="0">
         <binaryOption name="sim_sopt4_ftm%(ftmNum)flt1" 
            description="FTM%(ftmNum) Fault 1 Select"
            toolTip="Source of FTM fault input 1" >
            <choice value="0"  name="FTM%(ftmNum)_FLT1 pin" data="Ftm%(ftmNum)Fault1" isDefault="true" />
            <choice value="1"  name="CMP1 output"   data="Cmp1" />
         </binaryOption>
      </for>
   </category>
   
   <category name="SOPT5" description="UART signals">
      <choiceOption name="sim_sopt5_uart0rxsrc" 
         description="UART 0 receive data source"
         toolTip="Source for the UART receive data">
         <choice value="0" name="UART0_RX pin"    data="Uart0Rx"  isDefault="true" />
         <choice value="1" name="CMP0 output"     data="Cmp0" />
         <choice value="2" name="CMP1 output"     data="Cmp1" />
      </choiceOption>
      
      <binaryOption name="sim_sopt5_uart0txsrc" 
         description="UART 0 transmit data source"
         toolTip="Source for the UART transmit data.">
         <choice value="0" name="UART0_TX pin"     isDefault="true"                data="Direct" />
         <choice value="1" name="UART0_TX pin modulated by FTM1 channel 0 output"  data="ModulatedByFtm1Ch0" />
      </binaryOption>
      
      <choiceOption name="sim_sopt5_uart1rxsrc" 
         description="UART 1 receive data source"
         toolTip="Source for the UART receive data">
         <choice value="0" name="UART1_RX pin"     data="Uart1Rx"  isDefault="true" />
         <choice value="1" name="CMP0 output"      data="Cmp0" />
         <choice value="2" name="CMP1 output"      data="Cmp1" />
      </choiceOption>
      
      <binaryOption name="sim_sopt5_uart1txsrc" 
         description="UART 1 transmit data source"
         toolTip="Source for the UART transmit data.">
         <choice value="0" name="UART1_TX pin" isDefault="true"                    data="Direct" />
         <choice value="1" name="UART1_TX pin modulated by FTM1 channel 0 output"  data="ModulatedByFtm1Ch0" />
      </binaryOption>
      
   </category>

   <category name="SOPT7" description="ADC signals">
      <for keys="adc" values="0">
         <choiceOption name="sim_sopt7_adc%(adc)trigger" 
            description="ADC%(adc) trigger mode"
            toolTip="Alternative conversion triggers for ADC\n
               _Pdb              - ADC is triggered by PDB.\n
               _Alt_PreTrigger_0 - ADC is triggered by SimAdc0Trigger selection and uses pretrigger 0 = A (SC1[0]/R[0])\n
               _Alt_PreTrigger_1 - ADC is triggered by SimAdc0Trigger selection and uses pretrigger 1 = B (SC1[1]/R[1])" >
            <choice value="SIM_SOPT7_ADC0ALTTRGEN(0)" 
               name="Triggered by PDB"     data="Pdb" isDefault="true" />
            <choice value="SIM_SOPT7_ADC%(adc)ALTTRGEN(1)|SIM_SOPT7_ADC%(adc)PRETRGSEL(0)" 
               name="Pre-trigger 0 = A (SC1[0])"             data="Alt_PreTrigger_0" />
            <choice value="SIM_SOPT7_ADC%(adc)ALTTRGEN(1)|SIM_SOPT7_ADC%(adc)PRETRGSEL(1)" 
               name="Pre-trigger 1 = B (SC1[1])"             data="Alt_PreTrigger_1" />
         </choiceOption>
      
         <choiceOption name="sim_sopt7_adc%(adc)trgsel"
            description="ADC%(adc) trigger"
            toolTip="Trigger source when alternative triggers are functional in stop and VLPS modes">
            <choice value="0"  name="External trigger pin input (PDB0_EXTRG)" data="External" isDefault="true" />
            <choice value="1"  name="CMP 0 output"                            data="Cmp0"       />
            <choice value="1"  name="CMP 1 output"                            data="Cmp1"       />
            <choice value="4"  name="PIT trigger 0"                           data="PitCh0"     />
            <choice value="5"  name="PIT trigger 1"                           data="PitCh1"     />
            <choice value="6"  name="PIT trigger 2"                           data="PitCh2"     />
            <choice value="7"  name="PIT trigger 3"                           data="PitCh3"     />
            <choice value="8"  name="FTM0 trigger"                            data="Ftm0"       />
            <choice value="9"  name="FTM1 trigger"                            data="Ftm1"       />
            <choice value="12" name="RTC alarm"                               data="RtcAlarm"   />
            <choice value="13" name="RTC seconds"                             data="RtcSeconds" />
            <choice value="14" name="LPTMR trigger"                           data="Lptmr"      />
         </choiceOption>
      </for>      
   </category>
    
   <xi:include href="_simCommon.xml"/>

   <indexedCategory name="ClockConfig." dim="/SIM/numberOfClockSettings" 
        derived="true"
        constant="true"
        value=""
        description="Clock configurations" 
        toolTip="Clock configurations for different run modes" >
      
      <aliasOption key="/MCG/ClockConfig." constant="true"/>
      
      <choiceOption name="sim_sopt2_pllfllsel."
         description="Peripheral Clock"
         toolTip="Clock for various peripherals (LPUART, TPM etc.)">
         <choice value="0"  name="MCGFLLCLK clock" data="McgFll#SystemMcgFllClock"   isDefault="true" />
         <choice value="1"  name="MCGPLLCLK clock" data="McgPll#SystemMcgPllClock" />
      </choiceOption>
   
      <intOption name="system_peripheral_clock."
         derived="true"
         constant="true"
         units="Hz"
         description="Peripheral Clock frequency"
         toolTip="Frequency of Peripheral Clock available to various peripherals"  />
	 
      <choiceOption name="sim_sopt2_usbsrc." 
         description="USB Clock"
         toolTip="Source for the USB clock">
         <choice value="0"  name="External bypass clock (USB_CLKIN)" data="External" />
         <choice value="1"  name="Peripheral Clock/SIM_CLKDIV2"      data="PeripheralClk" isDefault="true" />
      </choiceOption>
      
      <intOption name="system_usbfs_clock." 
         derived="true"
         constant="true"
         units="Hz"
         description="USB Full Speed Clock"
         toolTip="Frequency of clock to USB full speed controller"
         value="0" />
    
      <choiceOption name="sim_clkdiv2_usb."
         description="USB clock divider" 
         toolTip="Sets the clock divider when the MCGFLLCLK, MCGPLLCLK, or IRC48M clock\n
         is the USB clock source.">
         <choice value="1" name="Multiply by 2 (div=0, frac=1)" />
         <choice value="0" name="Multiply by 1 (div=0, frac=0)" />
         <choice value="3" name="Multiply by 1 (div=1, frac=1)" />
         <choice value="5" name="Divide by 1.5 (div=2, frac=1)" />
         <choice value="2" name="Divide by 2 (div=1, frac=0)" />
         <choice value="7" name="Divide by 2 (div=3, frac=1)" />
         <choice value="9" name="Divide by 2.5 (div=4, frac=1)" />
         <choice value="4" name="Divide by 3 (div=2, frac=0)" />
         <choice value="11" name="Divide by 3 (div=5, frac=1)" />
         <choice value="13" name="Divide by 3.5 (div=6, frac=1)" />
         <choice value="6" name="Divide by 4 (div=3, frac=0)" />
         <choice value="15" name="Divide by 4 (div=7, frac=1)" />
         <choice value="8" name="Divide by 5 (div=4, frac=0)" />
         <choice value="10" name="Divide by 6 (div=5, frac=0)" />
         <choice value="12" name="Divide by 7 (div=6, frac=0)" />
         <choice value="14" name="Divide by 8 (div=7, frac=0)" />
      </choiceOption>
   
      <intOption name="system_core_clock." 
         units="Hz"
         description="System Core Clock"
         toolTip="Clocks the ARM Cortex-M4 core and bus masters"
         value="48 MHz" />
      
      <intOption name="system_bus_clock." 
         units="Hz"
         description="System Bus Clock"
         toolTip="Clocks the bus slaves and peripherals\n
                  Must be &lt;= Core Clock frequency and an integer divisor"
         value="48 MHz" />
      
      <intOption name="system_flash_clock." 
         units="Hz"
         description="System Flash Clock"
         toolTip="Clocks the flash memory\n
                  Must be an integer divisor of the Core Clock.\n
                  Must be &lt;= Bus Clock frequency."
         value="24000000" />
      
      <category name="CLKDIV1" description="System Clock Dividers">
         <intOption name="sim_clkdiv1_outdiv1." 
            derived="true"
            constant="true"
            description="Core &amp; System Clock Divider (OUTDIV1) - Divide by [1-16]"
            toolTip="Clocks the ARM Cortex-M4 core and bus masters [SIM_CLKDIV1_OUTDIV1]\n
                     Divides MCGOUT Clock to generate system_core_clock"
            value="1" offset="-1" min="1" max="16" />
         
         <intOption name="sim_clkdiv1_outdiv2." 
            derived="true"
            constant="true"
            description="Bus Clock Divider (OUTDIV2) - Divide by [1-16]"
            toolTip="Clocks the bus slaves and peripheral [SIM_CLKDIV1_OUTDIV2]\n
               Divides MCGOUT Clock to generate system_bus_clock\n
               MCGOUTCLK clock is source. Default /2"
            value="1" offset="-1" min="1" max="16" />
         
         <intOption name="sim_clkdiv1_outdiv4." 
            derived="true"
            constant="true"
            description="Flash Clock Divider (OUTDIV4) - Divide by [1-16]"
            toolTip="Clocks the flash memory [SIM_CLKDIV1_OUTDIV4]\n
                     Divides MCGOUT Clock to generate system_flash_clock\n
                     MCGOUTCLK clock is source. Default /4"
            value="4" offset="-1" min="1" max="16" />
      </category>
   </indexedCategory>
   
   <template><![CDATA[
      \t/**
      \t * Update system clock values
      \t *
      \t * @param systemClock Frequency of clock provided to system clock dividers
      \t */
      \tstatic void updateSystemClocks(unsigned systemClock) {
      \t
      \t   SystemCoreClock    = systemClock/(((SIM->CLKDIV1&SIM_CLKDIV1_OUTDIV1_MASK)>>SIM_CLKDIV1_OUTDIV1_SHIFT)+1);
      \t   SystemBusClock     = systemClock/(((SIM->CLKDIV1&SIM_CLKDIV1_OUTDIV2_MASK)>>SIM_CLKDIV1_OUTDIV2_SHIFT)+1);
      \t#ifdef SIM_CLKDIV1_OUTDIV3_MASK
      \t   SystemFlexbusClock = systemClock/(((SIM->CLKDIV1&SIM_CLKDIV1_OUTDIV3_MASK)>>SIM_CLKDIV1_OUTDIV3_SHIFT)+1);
      \t#endif
      \t#ifdef SIM_CLKDIV1_OUTDIV4_MASK
      \t//   XXXX = systemClock/(((SIM->CLKDIV1&SIM_CLKDIV1_OUTDIV4_MASK)>>SIM_CLKDIV1_OUTDIV4_SHIFT)+1);
      \t#endif
      \t}\n\n
   ]]></template>

   <xi:include href="_sim_commonTemplates.xml" />

   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.SimValidate" dim="/SIM/numberOfClockSettings">
      <param type="long" value="50MHz" />    <!-- Core         -->
      <param type="long" value="50MHz" />    <!-- Bus          -->
      <param type="long" value="25MHz" />    <!-- Flash        -->
      <param type="long" value="50MHz" />    <!-- FlexBus      -->
   </validate>
   
   <xi:include href="_simFiles-MK.xml"/>
   
</peripheralPage>
