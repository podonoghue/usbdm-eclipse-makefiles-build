<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE peripheralPage SYSTEM "_menu.dtd" >
<!-- mcg_nopll_def.xml -->
 
<peripheralPage xmlns:xi="http://www.w3.org/2001/XInclude" name="_instance" description="Multipurpose Clock Generator">
   
   <xi:include href="_default_instance.xml"/>

   <category name="OSC0 (Main Oscillator)" description="OSC External Reference Clock/Oscillator [OSCCLK]" >
      <aliasOption key="/OSC0/osc_input_freq" constant="false" />
      <binaryOption name="mcg_c2_erefs0"
         description="External Reference Select" 
         toolTip="Determines whether a clock or crystal is used for the external reference clock" >
         <choice value="0" name="External clock" />
         <choice value="1" name="Oscillator" isDefault="true" />
      </binaryOption>
      <binaryOption name="mcg_c2_hgo0"
         description="Oscillator Gain" 
         toolTip="Controls the crystal oscillator mode of operation">
         <choice value="0" name="Low power" isDefault="true"/>
         <choice value="1" name="High gain" />
      </binaryOption>
   </category>
   
   <category name="Real Time Clock" description="RTC External Reference Clock/Oscillator 32k mode [ERCLK32K]">
      <aliasOption key="/RTC/rtc_cr_osce"           optional="true" constant="false"/>
      <aliasOption key="/RTC/osc_clock"             optional="true"/>
      <aliasOption key="/SIM/sim_sopt1_osc32ksel"   optional="true" constant="false" />
      <aliasOption key="/SIM/system_erclk32k_clock" optional="true"/>
   </category>
   
   <category name="Internal Clocks" description="Clock Sources"
      toolTip="SLOW_IRC, FAST_IRC, USB_CLKIN, LPO" >
      <intOption name="system_slow_irc_clock"
         origin="SLOW IRC"
         units="Hz"
         description="Frequency of Slow Internal Reference [SIRC] Clock"
         toolTip="Dependent on device and clock Trim. [Typically ~32kHz]"
         value="32768" />

      <intOption name="system_fast_irc_clock"
         origin="FAST IRC"
         units="Hz"
         description="Frequency of Fast Internal Reference [FIRC] Clock"
         toolTip="Dependent on device and clock Trim. [Typically ~4MHz]"
         value="4000000" />

      <aliasOption name="/PMC/system_low_power_clock" />
    
   </category>
   
   <xi:include href="_irqOption.xml"/>
      
   <aliasOption key="/SIM/numberOfClockSettings" />     

   <indexedCategory name="ClockConfig."  dim="/SIM/numberOfClockSettings"
         description="Clock configuration" 
         toolTip="Clock configurations for different run modes"
         value="ClockConfig_."  >
         
      <category name="Clock monitors" 
         description="Clock monitors" >
         <binaryOption name="mcg_c6_cme0."
            description="OSC0 Clock Monitor Enable"
            toolTip="Enables the loss of clock monitoring circuit for the OSC0 external reference.\n
                     C2.LOCRE0 determines if an interrupt or a reset request is generated.\n
                     The CME0 bit must only be when using an external clock mode (FEE, FBE, PEE, PBE, or BLPE)." >
            <choice value="0" name="Clock monitor disabled" />
            <choice value="1" name="Clock monitor enabled" />
         </binaryOption>
         <binaryOption name="mcg_c2_locre0."
            description="OSC0 Action on Loss of Clock" 
            toolTip="Determines if an Interrupt or Reset occurs on loss of OSC0 external reference\n
                     This option only has effect if the clock monitor is first enabled bye C6.CME0">
            <choice value="0" name="Interrupt request" />
            <choice value="1" name="Reset request" />
         </binaryOption>
      </category>
      
      <category name="MCGIR" description="Internal Reference Clock Sources [MCGIRCLK]" >
         <choiceOption name="mcg_sc_fcrdiv."
            description="Fast Internal Clock [FIRC] Reference Divider"
            toolTip="Selects the amount to divide down the fast internal reference clock\n
               The FIR clock is available for use as MCGIRCLK or MCGOUTCLK">
            <choice value="0" name="Divide by 1" isDefault="true" />
            <choice value="1" name="Divide by 2" />
            <choice value="2" name="Divide by 4" />
            <choice value="3" name="Divide by 8" />
            <choice value="4" name="Divide by 16" />
            <choice value="5" name="Divide by 32" />
            <choice value="6" name="Divide by 64" />
            <choice value="7" name="Divide by 128" />
         </choiceOption>
   
         <binaryOption name="mcg_c2_ircs."
            description="Internal Reference [MCGIRCLK] Clock Source" 
            toolTip="Clock Source for MCGIRCLK" >
            <choice value="0" name="Slow internal reference clock" />
            <choice value="1" name="Fast internal reference clock" isDefault="true" />
         </binaryOption>
   
         <binaryOption name="mcg_c1_irclken."
            description="Internal Reference [MCGIRCLK] Clock Enable "
            toolTip="Enables the internal reference clock for use by peripherals as MCGIRCLK">
            <choice value="0" name="Disabled" />
            <choice value="1" name="Enabled" isDefault="true"/>
         </binaryOption>
   
         <binaryOption name="mcg_c1_irefsten."
            description="Internal Reference [MCGIRCLK] Stop Enable" 
            toolTip="Determines if MCGIRCLK is enabled in Stop mode">
            <choice value="0" name="IR disabled in STOP" />
            <choice value="1" name="IR enabled in STOP" />
         </binaryOption>
   
         <intOption name="system_mcgirclk_clock." 
            derived="true" 
            constant="true"
            units="Hz"
            description="Frequency of Internal Reference [MCGIRCLK] "
            toolTip="Derived from system_slow_irc_clock or system_fast_irc_clock/fcrdiv"
            value="48000000" />
      </category>
   
      <intOption name="mcg_erc_clock." 
         derived="true"
         constant="true"  
         units="Hz"
         description="MCG External Reference Clock [OSCSELCLK]"
         toolTip="External reference clock input to PLL/FLL"
         value="12000000" />
   
      <choiceOption name="clock_mode." 
         description="Default Clock Mode"
         toolTip="FLL Engaged Internal(FEI)\n
                  In FEI mode, MCGOUT is derived from the FLL clock (DCOCLK) that is controlled by the 32 kHz Internal Reference Clock (IRC).\n
                  The FLL loop will lock the DCO frequency to the FLL factor, as selected by the C4[DRST_DRS] and C4[DMX32] bits, times the\n
                  internal reference frequency.\n
                  \n
                  FLL Engaged External(FEE)\n
                  In FEE mode, MCGOUT is derived from the FLL clock (DCOCLK) that is controlled by the external reference clock. The FLL loop\n
                  will lock the DCO frequency to the FLL factor, as selected by C4[DRST_DRS] and C4[DMX32] bits, times the external reference\n
                  frequency, as specified by the C1[FRDIV] and C2[RANGE].\n
                  \n
                  FLL Bypassed Internal(FBI)\n
                  In FBI mode, the MCGOUT clock is derived either from the slow (32 kHz IRC) or fast (2/4 MHz IRC) internal reference clock,\n
                  as selected by the C2[IRCS] bit. The FLL is operational but its output is not used. This mode is useful to allow the FLL\n
                  to acquire its target frequency while the MCGOUT clock is driven from the C2[IRCS] selected internal reference clock. The\n
                  FLL clock (DCOCLK) is controlled by the slow internal reference clock, and the DCO clock frequency locks to a multiplication\n
                  factor, as selected by the C4[DRST_DRS] and C4[DMX32] bits, times the internal reference frequency.\n
                  \n
                  FLL Bypassed External(FBE)\n
                  In FBE mode, the MCGOUT clock is derived from the external reference clock. The FLL is operational but its output is not\n
                  used. This mode is useful to allow the FLL to acquire its target frequency while the MCGOUT clock is driven from the\n
                  external reference clock. The FLL clock (DCOCLK) is controlled by the external reference clock, and the DCO clock frequency\n
                  locks to a multiplication factor, as selected by the C4[DRST_DRS] and C4[DMX32] bits, times the divided external reference\n
                  frequency.\n
                  \n
                  Bypassed Low Power Internal (BLPI/FBILP)\n
                  In BLPI mode, MCGOUT is derived from the internal reference clock. The FLL is disabled and PLL is disabled even if the\n
                  C5[PLLCLKEN] is set to 1.\n
                  \n
                  Bypassed Low Power External (BLPE/FBELP)\n
                  In BLPE mode, MCGOUT is derived from the external reference clock. The FLL is disabled and PLL is disabled even if the\n
                  C5[PLLCLKEN] is set to 1.">
         <choice name="FLL Engaged Internal (FEI)"          value="ClockMode_FEI" />
         <choice name="FLL Engaged External (FEE)"          value="ClockMode_FEE" />
         <choice name="FLL bypassed internal (FBI)"         value="ClockMode_FBI" />
         <choice name="FLL bypassed external (FBE)"         value="ClockMode_FBE" />
         <choice name="Bypassed low power internal (BLPI)"  value="ClockMode_BLPI" />
         <choice name="Bypassed low power external (BLPE)"  value="ClockMode_BLPE" />
      </choiceOption>
  
      <category name="FLL" description="FLL Settings">
         <binaryOption name="fll_enabled."
            derived="true"
            constant="true"
            description="FLL State"
            toolTip="Determined from clock mode selected" >
            <choice value="0" name="FLL Inactive" />
            <choice value="1" name="FLL Active" />
         </binaryOption>
   
      <choiceOption name="mcg_c2_range."
         derived="true"
         constant="true"
         description="Frequency Range Select"
         toolTip="Selects the frequency range for the crystal oscillator\n
                  and/or divider for FLL input clock">
         <choice value="0" name="Low range" />
         <choice value="1" name="High range" />
         <choice value="2" name="Very High range" />
         <choice value="0" name="Unused" />
      </choiceOption>
         
         <choiceOption name="mcg_c1_frdiv."
            derived="true"
            constant="true"
            description="FLL External Reference Divider"
            toolTip="Selects the amount to divide down the external reference clock for the FLL.\n
                     The resulting frequency must be in the range 31.25 kHz to 39.0625 kHz\n
                     Division factor depends on Clock Range [MGC_C2_RANGE0]\n
                     This option is determined by the Clock Mode and FLL input clock">
            <choice value="0" name="if RANGE0 = low, divide by 1, else 32" />
            <choice value="1" name="if RANGE0 = low, divide by 2, else 64" />
            <choice value="2" name="if RANGE0 = low, divide by 4, else 128" />
            <choice value="3" name="if RANGE0 = low, divide by 8, else 256" />
            <choice value="4" name="if RANGE0 = low, divide by 16, else 512" />
            <choice value="5" name="if RANGE0 = low, divide by 32, else 1024" />
            <choice value="6" name="if RANGE0 = low, divide by 64, else 1280" />
            <choice value="7" name="if RANGE0 = low, divide by 128, else 1536" />
         </choiceOption>
   
         <intOption name="fllInputFrequency." 
            derived="true"
            constant="true"
            units="Hz"
            description="FLL Input clock frequency"
            toolTip="Frequency of input to FLL"
            value="32000" />
   
         <intOption name="system_mcgfllclk_clock." 
            units="Hz"
            description="FLL Output clock frequency"
            toolTip="Used for main MCGOUTCLK system clock if FEI or FEE mode is selected"
            value="96000000" 
            disabledValue="0" />
   
         <binaryOption name="mcg_c4_dmx32."
            description="DMX32 DCO lock range" 
            toolTip="Allows the FLL parameters to be optimised for maximum output frequency\n
                     with a 32.768 kHz FLL input clock" >
            <choice value="0" name="Wide: [31.25-39.06] kHz" />
            <choice value="1" name="Narrow: 32.768 kHz" />
         </binaryOption>
   
         <choiceOption name="mcg_c4_drst_drs."
            derived="true"
            constant="true"
            description="DCO Range Select"
            toolTip="Frequency range for the FLL output, DCOOUT\n
                     This is determined from the FLL input and output clock frequencies" >
            <choice value="0" name="Low (x640/x732, 20-25/24 MHz)" />
            <choice value="1" name="Mid (x1280/x1464, 40-50/48 MHz)" />
            <choice value="2" name="Mid-high (x1920/x2197, 60-75/72 MHz)" />
            <choice value="3" name="High (x2560/x2929, 80-100/96 MHz)" />
         </choiceOption>
   
         <intOption name="system_mcgffclk_clock."
            units="Hz"
            derived="true"
            constant="true"  
            description="MCG Fixed Frequency Clock [MCGFFCLK]"
            toolTip="Used as input clock to FLL and available to some peripherals\n
                     Derived from External Reference Clock or Slow IRC"
            value="12000000" />
      </category>
      
      <aliasOption key="/SIM/system_peripheral_postdivider_clock." constant="true"  optional="true"/>

      <aliasOption name="system_mcgirclk_clock." />
      <aliasOption name="system_mcgffclk_clock." />
      <aliasOption key="/OSC0/oscer_undiv_clock" optional="true" />
      <aliasOption key="/OSC0/oscer_clock" />
      <aliasOption key="/SIM/system_erclk32k_clock" />
      <aliasOption key="/PMC/system_low_power_clock" />
   
      <stringOption name="system_mcgoutclk_clock_source."
         derived="true" 
         constant="true"
         description="System MCG Output Clock source [MCGOUTCLK]" 
         toolTip="Source of MCG Output Clock\n
                  Determined by current clock mode" />
      
      <intOption name="system_mcgoutclk_clock." 
         derived="true" 
         constant="true"
         units="Hz"
         description="System MCG Output Clock [MCGOUTCLK]"
         toolTip="MCG Main clock output\n
                  Derived from slow IRC, fast IRC, ERC, FLL or PLL"
         value="120000000" />
   
      <aliasOption key="/SIM/system_core_clock."    constant="false" />
      <aliasOption key="/SIM/system_bus_clock."     constant="false" />
      <aliasOption key="/SIM/system_flexbus_clock." constant="false"  optional="true" />
      <aliasOption key="/SIM/system_flash_clock."   constant="false"  optional="true" />

      <category name="Device Parameters" description="Register values">
         <category name="MCG_C1" description="MCG Control Register 1">
            <choiceOption name="mcg_c1_clks."
               derived="true"
               constant="true"
               description="MCGOUTCLK Clock Source Select"
               toolTip="Selects the clock source for MCGOUTCLK\n
                        This option is determined by the Clock Mode selection\n" >
               <choice value="0" name="Output of FLL or PLL is selected" />
               <choice value="1" name="Internal reference clock is selected" />
               <choice value="2" name="External reference clock is selected" />
            </choiceOption>
      
            <aliasOption name="mcg_c1_frdiv." />
      
            <binaryOption name="mcg_c1_irefs."
               derived="true"
               constant="true"
               description="Internal Reference Select"
               toolTip="Selects the reference clock source for the FLL\n
                        This option is determined by the Clock Mode selection">
               <choice value="0" name="External Reference Clock" />
               <choice value="1" name="Slow Internal Clock" />
            </binaryOption>
      
            <aliasOption name="mcg_c1_irclken." />
            <aliasOption name="mcg_c1_irefsten." />
         </category>
         
         <category name="MCG_C2" description="MCG Control Register 2">
            <aliasOption name="mcg_c2_locre0." />
            <aliasOption key="mcg_c2_range." />
            <aliasOption key="mcg_c2_hgo0" />
            <aliasOption key="mcg_c2_erefs0" />
      
            <binaryOption name="mcg_c2_lp."
               derived="true"
               constant="true"
               description="Low Power Select" 
               toolTip="Whether FLL or PLL continues operation when bypassed\n
                        This option is determined by the Clock Mode selection">
               <choice value="0" name="FLL/PLL is enabled in bypass modes" />
               <choice value="1" name="FLL/PLL is disabled in bypass modes" />
            </binaryOption>
      
            <aliasOption name="mcg_c2_ircs." />
         </category>
         
         <category name="MCG_C4" description="MCG Control Register 4">
            <aliasOption name="mcg_c4_dmx32." />
            <aliasOption name="mcg_c4_drst_drs." />
         </category>
         
         <category name="MCG_C6" description="MCG Control Register 6">
            <aliasOption name="mcg_c6_cme0." />
         </category>
   
         <category name="MCG_SC" description="MCG Status and Control Register" >
            <aliasOption name="mcg_sc_fcrdiv." />
         </category>
         
      </category>
   </indexedCategory>
   
   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.ClockValidator_MCG_no_pll" dim="/SIM/numberOfClockSettings" >
      <param type="long" value="1" />              <!-- mcg_c4_drst_drs max -->
   </validate>

   <projectActionList id = "mcg_files" >
      <copy source="Startup_Code/mcg_no_pll.cpp"          target="Startup_Code/mcg_no_pll.cpp"           overwrite="true"  derived="true" />
      <copy source="Project_Headers/mcg.h"                target="Project_Headers/mcg.h"                 overwrite="true"  derived="true" />
      <copy source="Snippets/mcg-test.cpp"                target="Snippets/mcg-test.cpp"                 overwrite="true"  derived="true" />
      <deleteResource target="Project_Headers/clock_configure.h" />
      <deleteResource target="Startup_Code/clock.c" />
   </projectActionList>
         
   <template><![CDATA[
      \t//! Not present on these devices
      \tstatic constexpr int ERRATA_E2448 = 0;
      
      \tenum ClockMode : uint8_t {
      \t   ClockMode_FEI      = 0,
      \t   ClockMode_FEE,
      \t   ClockMode_FBI,
      \t   ClockMode_BLPI,
      \t   ClockMode_FBE,
      \t   ClockMode_BLPE,
      \t};
      
      \t//! Frequency of Slow Internal Reference Clock [~32kHz]
      \tstatic constexpr uint32_t system_slow_irc_clock = $(system_slow_irc_clock)UL;
      
      \t//! Frequency of Fast Internal Reference Clock [~4MHz]
      \tstatic constexpr uint32_t system_fast_irc_clock = $(system_fast_irc_clock)UL;

      \t//! Structure for clock configurations
      \tstruct ClockInfo {
      \t   //! System Clock Divider Register 1
      \t   const uint32_t clkdiv1;
      
      \t   //! Clock Mode
      \t   const ClockMode clockMode:8;
      
      \t   //! Control Register 1 - FRDIV, IRCLKEN, IREFSTEN, (-CLKS, -IREFS)
      \t   const uint8_t c1;
      \t   //! Control Register 2 - LOCRE0, RANGE0, HGO0, EREFS0, IRCS, (-LP)
      \t   const uint8_t c2;
      \t   //! Control Register 4 - DMX32, DRST_DRS
      \t   const uint8_t c4;
      \t   //! Control Register 6 - CME0
      \t   const uint8_t c6;
      \t   //! Status and Control Register - FCRDIV
      \t   const uint8_t sc;
      \t};

      \t/**
      \t * Get MCGERCLK
      \t *
      \t * @return MCGERCLK as uint32_t
      \t */
      \tstatic uint32_t getErcClock() {
      \t   return Osc0Info::getOscClock();
      \t}
      
      \t/**
      \t * Get Internal MCGIRCLK (ungated by MCG_C1_IRCLKEN_MASK)
      \t *
      \t * @return MCGIRCLK as uint32_t
      \t */
      \tstatic uint32_t getInternalIrcClock() {
      \t      if (mcg->C2&MCG_C2_IRCS_MASK) {
      \t#ifdef MCG_SC_FCRDIV_MASK
      \t         return (system_fast_irc_clock/(1<<((mcg->SC&MCG_SC_FCRDIV_MASK)>>MCG_SC_FCRDIV_SHIFT)));
      \t#else
      \t         return system_fast_irc_clock;
      \t#endif
      \t      }
      \t      else {
      \t         return system_slow_irc_clock;
      \t      }
      \t}
      
      \t/**
      \t * Get MCGIRCLK (gated by MCG_C1_IRCLKEN_MASK)
      \t *
      \t * @return MCGIRCLK as uint32_t
      \t */
      \tstatic uint32_t getMcgIrClock() {
      \t   if (mcg->C1&MCG_C1_IRCLKEN_MASK) {
      \t      return getInternalIrcClock();
      \t   }
      \t   else {
      \t      return 0;
      \t   }
      \t}\n\n
   ]]></template>
   
   <template name="ClockConfig" dim="/SIM/numberOfClockSettings" namespace="all" ><![CDATA[
      \t$(ClockConfig.://-- missing name for configuration --),\n
   ]]></template>
   
   <template name="McgClockInfoEntries" dim="/SIM/numberOfClockSettings" namespace="all" ><![CDATA[
      \t   {  // $(ClockConfig.) ($(clock_mode.))
      \t      
      \t      //! SIM CLKDIV1 System Clock Divider Register 1
      \t      SIM_CLKDIV1_OUTDIV4($(/SIM/sim_clkdiv1_outdiv4.:0))|  // Flash clock
      \t      SIM_CLKDIV1_OUTDIV3($(/SIM/sim_clkdiv1_outdiv3.:0))|  // FlexBus clock
      \t      SIM_CLKDIV1_OUTDIV2($(/SIM/sim_clkdiv1_outdiv2.:0))|  // Bus clock
      \t      SIM_CLKDIV1_OUTDIV1($(/SIM/sim_clkdiv1_outdiv1.:0)),  // Core/system clock
              
      \t      //! Clock Mode
      \t      McgInfo::$(clock_mode.),
              
      \t      //! Control Register 1 - Excluding CLKS, IREFS
      \t      MCG_C1_FRDIV($(mcg_c1_frdiv.))   | // FRDIV    FLL External Reference Divider
      \t      MCG_C1_IRCLKEN($(mcg_c1_irclken.)) | // IRCLEN   Internal Reference Clock Enable
      \t      MCG_C1_IREFSTEN($(mcg_c1_irefsten.)), // IREFSTEN Internal Reference Stop Enable
              
      \t      //! Control Register 2 - Excluding LP
      \t      MCG_C2_LOCRE0($(mcg_c2_locre0.)) | // LOCRE0  Loss of Clock Reset Enable
      \t      MCG_C2_RANGE0($(mcg_c2_range.)) | // RANGE   Frequency Range Select
      \t      MCG_C2_HGO0($(mcg_c2_hgo0))   | // HGO     High Gain Oscillator Select
      \t      MCG_C2_EREFS0($(mcg_c2_erefs0)) | // EREFS   External Reference Select
      \t      MCG_C2_IRCS($(mcg_c2_ircs.)),    // IRCS    Internal Reference Clock Select
              
      \t      //! Control Register 4
      \t      MCG_C4_DMX32($(mcg_c4_dmx32.))     | // DMX32    DCO lock range
      \t      MCG_C4_DRST_DRS($(mcg_c4_drst_drs.)),   // DRST_DRS DCO Range Select
              
      \t      //! Control Register 6
      \t      MCG_C6_CME0($(mcg_c6_cme0.)), // CME0   Clock Monitor Enable
              
      \t      //! Status and Control Register
      \t      MCG_SC_FCRDIV($(mcg_sc_fcrdiv.)), // FCRDIV Internal Clock Reference Divider
      \t   },\n
   ]]></template>
</peripheralPage>
