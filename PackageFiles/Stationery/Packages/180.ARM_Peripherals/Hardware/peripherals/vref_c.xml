<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE peripheralPage SYSTEM "_menu.dtd" >
<!-- vref_c.xml -->

<peripheralPage xmlns:xi="http://www.w3.org/2001/XInclude" name="_instance" description="Voltage Reference" >

   <equation key="irq_parameters"            value=""  />
   <equation key="irq_dummy_parameters"      value=""  />
   <equation key="irq_call"                  value=""  />
   <equation key="generateDefault"           value="false"         />
   <equation key="configureInStartupDefault" value="false"         />
   <xi:include href="enablePeripheral.xml"  />
   <title />

   <constant key="disable_peripheral"  value = "&quot;vref->SC = 0;&quot;" type="String"  />

   <template><![CDATA[
      \t//! Pin number in Info table for VREF output if mapped to a pin
      \tstatic constexpr int outputPin  = 0;\n\n
   ]]></template>

   <!-- ************* Class Declaration ****************** -->

   <constant key="_class_declaration" type="String"
      value="&quot;$(_Class)Info : public $(_Structname)BasicInfo&quot;" />

   <!-- ************* SC ****************** -->

   <binaryOption key="vref_sc_vrefen" condition="vref_sc_vrefen_present"
      enabledBy="enablePeripheralSupport"
      typeName="VrefEnable"
      description="Internal Voltage Reference enable"
      toolTip="Controls the bandgap reference within the Voltage Reference module" >
      <choice value="0" name="Disabled" enum="Disabled" />
      <choice value="1" name="Enabled"  enum="Enabled"  isDefault="true" />
   </binaryOption>

   <binaryOption key="vref_sc_regen" condition="vref_sc_regen_present"
      enabledBy="vref_sc_vrefen"
      typeName="VrefReg"
      description="Regulator enable"
      toolTip="Controls the internal 1.75 V regulator which produce a constant\n
         internal voltage supply in order to reduce the sensitivity to external supply noise and variation\n
         If it is desired to keep the regulator enabled in very low power modes see PmcBandgapLowPowerEnable" >
      <choice value="0" name="Disabled" enum="Disabled" />
      <choice value="1" name="Enabled"  enum="Enabled"  isDefault="true" />
   </binaryOption>

   <!-- ************* TRM ****************** -->

   <binaryOption key="vref_trm_chopen" condition="vref_trm_chopen_present"
      enabledBy="vref_sc_vrefen"
      typeName="VrefChop"
      description="Chop oscillator enable"
      toolTip="Controls the internal chopping operation to minimise the internal analogue offset\n
               This option is enabled during factory trimming of the VREF voltage.\n
               This should be enabled to achieve the performance stated in the data sheet.\n
               If the chop oscillator is to be used in very low power modes, the system (bandgap)\n
               voltage reference must also be enabled. See PmcBandgapLowPowerEnable" >
      <choice value="0" name="Disabled" enum="Disabled" />
      <choice value="1" name="Enabled"  enum="Enabled"  isDefault="true" />
   </binaryOption>

   <intOption key="vref_trm_trim" condition="vref_trm_trim_present"
      enabledBy="enablePeripheralSupport"
      toolTip="Changes the resulting VREF by approximately ~0.5 mV for each step"
      description="Trim bits"
      typeName="int8_t"
      value="31"
      min="0"
      max="63"
      />

   <binaryOption key="vref_sc_icompen" condition="vref_sc_icompen_present"
      enabledBy="vref_sc_vrefen"
      typeName="VrefIcomp"
      description="Second order curvature compensation enable"
      toolTip="Controls the second order curvature compensation\.n
               This should be enabled to achieve the performance stated in the data sheet" >
      <choice value="0" name="Disabled" enum="Disabled" />
      <choice value="1" name="Enabled"  enum="Enabled" isDefault="true" />
   </binaryOption>

   <binaryOption key="vref_sc_vrefst" condition="vref_sc_vrefst_present"
      hidden="true"
      typeName="VrefStable"
      toolTip=""
      description="Internal Voltage Reference stable" >
      <choice name="Not ready"   value="0" enum="NotReady"/>
      <choice name="Ready"       value="1" enum="Ready"/>
   </binaryOption >

   <choiceOption key="vref_sc_mode_lv" condition="vref_sc_mode_lv_present"
      enabledBy="vref_sc_vrefen"
      typeName="VrefBuffer"
      description="Buffer Mode selection"
      toolTip="Selects the buffer mode for the Voltage Reference module" >
      <choice value="0" name="Bandgap on only, for stabilisation and startup" enum="Bandgap"    />
      <choice value="1" name="High power buffer mode enabled"                 enum="HighPower"  isDefault="true" />
      <choice value="2" name="Low-power buffer mode enabled"                  enum="LowPower"   />
   </choiceOption>

<!-- Setters and getters -->

   <template where="usbdm">
   <![CDATA[
      \t extern void waitUS(uint32_t usToWait);
      \t\n
   ]]>
   </template>
   
   <for keys="field           : get   : set   : clear : genCode                 : name"
        values="
         vref_trm_chopen      : true  : true  : false : enableGettersAndSetters : Chop;
         vref_trm_trim        : true  : true  : false : enableGettersAndSetters : Trim;
         vref_sc_vrefen       : true  : true  : false : enableGettersAndSetters : Enable;
         vref_sc_regen        : true  : true  : false : enableGettersAndSetters : Regulator;
         vref_sc_icompen      : true  : true  : false : enableGettersAndSetters : Compensastion;
         vref_sc_vrefst       : true  : false : false : enableGettersAndSetters : RegulatorStatus;
         vref_sc_mode_lv      : true  : true  : false : enableGettersAndSetters : BufferMode" >
      <variableTemplate variables="%(field)" condition="%(set)" codeGenCondition="%(genCode)"
      ><![CDATA[
         \t/**
         \t * Set %description
         \t *
         %paramDescription
         \t */
         \tstatic void set%(name)(%params) {
         \t   %fieldAssignment;
         \t}
         \t\n
      ]]></variableTemplate>
      <variableTemplate variables="%(field)" condition="%(get)" codeGenCondition="%(genCode)"
      ><![CDATA[
         \t/**
         \t * Get %description
         \t *
         \t * @return %tooltip
         \t */
         \tstatic %paramType get%(name)() {
         \t   return %paramType(%register&%mask);
         \t}
         \t\n
      ]]></variableTemplate>
      <variableTemplate variables="%(field)" condition="%(clear)" codeGenCondition="%(genCode)"
      ><![CDATA[
         \t/**
         \t * Set %description
         \t *
         \tstatic void clear%(name)() {
         \t   %register = %register|%mask;
         \t}
         \t\n
      ]]></variableTemplate>
   </for>

  <!--   ========== VREF Init class =============================== -->

   <template where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo" >
   <![CDATA[
      \t/**
      \t * Class used to do initialisation of the $(_Baseclass)
      \t *
      \t * This class has a templated constructor that accepts various values.
      \t * Parameters available may vary with device - see $(_Class)::DefaultInitValue for relevant example.
      \t * Omitted parameters default to zero (disabled) or unchanged if initialiser is provided as last parameter.
      \t *
      \t * @note This constructor may be used to create a const instance in Flash
      \t *
      \t * Example:
      \t * @code
      \t * static const $(_Class)::Init $(_name)Init {
      \t *
      \t *   // Setup values
      \t *   VrefEnable_Enabled ,    // Internal Voltage Reference enable - Enabled
      \t *   VrefChop_Enabled ,      // Chop oscillator enable - Enabled
      \t *   VrefReg_Enabled ,       // Regulator enable - Enabled
      \t *   VrefIcomp_Enabled ,     // Second order curvature compensation enable - Enabled
      \t *   VrefBuffer_HighPower,   // Buffer Mode selection - High power buffer mode enabled
      \t *   int8_t(31) ,            // Trim bits
      \t * };
      \t *
      \t * // Initialise $(_Class) from values specified above
      \t * $(_Class)::configure($(_name)Init)
      \t * @endcode
      \t */
      \tclass Init {
      \t
      \tpublic:
      \t   /**
      \t    * Copy Constructor
      \t    */
      \t   constexpr Init(const Init &other) = default;
      \t
      \t   /**
      \t    * Default Constructor
      \t    */
      \t   constexpr Init() = default;
      \t\n
   ]]>
   </template>

   <!--   Member variables -->

   <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
      variables="vref_trm_chopen,vref_trm_trim"
   ><![CDATA[
      \t   /// Trim Register
      \t   uint8_t %registerName = 0;\n\n
   ]]></variableTemplate>

   <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
      variables="vref_sc_vrefen,vref_sc_regen,vref_sc_icompen,vref_sc_mode_lv"
   ><![CDATA[
      \t   /// Status and Control Register
      \t   uint8_t %registerName = 0;\n\n
   ]]></variableTemplate>

   <!--   Constructors -->

   <for keys="r"
      values="
            vref_trm_chopen;
            vref_trm_trim;
            vref_sc_vrefen;
            vref_sc_regen;
            vref_sc_icompen;
            vref_sc_mode_lv
            " >
      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="%(r)"
         linePadding="xxx" >
      <![CDATA[
         \t   /**
         \t    * Constructor for %description
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         \t    *
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr Init(%params, Types... rest) : Init(rest...) {
         \t
         \t      %registerName = (%registerName&~%mask) | %paramExpression;
         \t   }
         \t\n
      ]]>
      </variableTemplate>
   </for>

   <template where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo" >
   <![CDATA[
      \t}; // class $(_Class)BasicInfo:Init
      \t\n
   ]]></template>

<!--   Default Initialisation value -->

   <variableTemplate codeGenCondition="enablePeripheralSupport"
      separator=","
      terminator=","
      variables="
            vref_trm_chopen,
            vref_trm_trim,
            vref_sc_vrefen,
            vref_sc_regen,
            vref_sc_icompen,
            vref_sc_mode_lv
         "
   ><![CDATA[
      \t/**
      \t * Default initialisation value for $(_Class)
      \t * This value is created from Configure.usbdmProject settings
      \t */
      \tstatic constexpr Init DefaultInitValue = {%initExpression
      \t};
      \t\n
   ]]></variableTemplate>

<!--   Configure methods -->

   <template codeGenCondition="enablePeripheralSupport" >
   <![CDATA[
      \t/**
      \t * Configure with default settings.
      \t * Configuration determined from Configure.usbdmProject
      \t */
      \tstatic inline void defaultConfigure() {
      \t
      \t   // Update settings
      \t   configure(DefaultInitValue);
      \t}
      \t
      \t/**
      \t * Configure $(_BASENAME) from values specified in init
      \t *
      \t * @param init Class containing initialisation values
      \t */
      \tstatic void configure(const Init &init) {
      \t
      \t   // Enable peripheral
      \t   enable();
      \t
      \t   uint8_t trm = init.trm;
      \t\n
   ]]></template>
   <if condition="vref_sc_regen&amp;&amp;vref_trm_chopen" >
      <variableTemplate codeGenCondition="enablePeripheralSupport"
         variables="vref_sc_regen, vref_trm_chopen"
         linePadding="xxx"
      ><![CDATA[
         \t   if (init.%registerName0&%mask0) {
         \t      // Chop must be enabled if regulator enabled
         \t      %registerName1 |= %mask1;
         \t   }\n
      ]]></variableTemplate>
   </if>
   <variableTemplate codeGenCondition="enablePeripheralSupport"
      variables="vref_sc_regen" >
   <![CDATA[
      \t   vref->TRM = trm;
      \t   %register0  = init.%registerName0 & ~%mask0;
      \t
      \t   // Regulator must be enabled >300ns after other settings
      \t   waitUS(1);
      \t   %register0 = init.%registerName0;
      \t
      \t   while ((vref->SC & VREF_SC_VREFST_MASK) == 0) {
      \t      // Wait until stable
      \t   }
      \t}
      \t\n
   ]]>
   </variableTemplate>

   <!-- ************* Common ****************** -->

   <template key="/$(_BASENAME)/declarations" codeGenCondition="enablePeripheralSupport" >
   <![CDATA[
      \t/**
      \t * Class representing $(_NAME)
      \t */
      \tclass $(_Class) : public $(_Baseclass)Base_T<$(_Class)Info> {};
      \t\n
   ]]>
   </template>

   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.PeripheralValidator" >
   </validate>

   <projectActionList id="vref_files" >
      <copy source="Project_Headers/vref.h"  target="Project_Headers/vref.h"  overwrite="true"  derived="true" />
   </projectActionList>

   <!-- ************* Startup ****************** -->

   <template key="/SYSTEM/Includes" condition="configurePeripheralInStartUp" codeGenCondition="configurePeripheralInStartUp" >
      <![CDATA[#include "$(_basename).h"\n
   ]]></template>

   <template key="/SYSTEM/Startup" condition="configurePeripheralInStartUp" codeGenCondition="configurePeripheralInStartUp" >
   <![CDATA[
      \t/*  Initialise $(_Class) */
      \tUSBDM::$(_Class)::defaultConfigure();\n
   ]]></template>

   <!-- ************* SIM configuration ****************** -->
   <category name="Advanced" description="SIM configuration" >
      <aliasOption key="=_scgc_clock"              locked="false" condition="_scgc_clock" />
   </category>

   <signals enabledBy="enablePeripheralSupport" locked="!/PCR/_present" />

</peripheralPage>
