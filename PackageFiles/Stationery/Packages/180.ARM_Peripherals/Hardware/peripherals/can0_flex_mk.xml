<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE peripheralPage SYSTEM "_menu.dtd" >
<!-- can0_flex_mk.xml -->

<peripheralPage xmlns:xi="http://www.w3.org/2001/XInclude" name="_instance" description="Flex Controller Area Network module" >

   <choiceOption key="irq_enum" condition="=_irqCount>1"
      valueFormat="%s"
      hidden="true"
      derived="true"
      typeName="$(_Class)IrqNum"
      description="$(_Class) Interrupt indices"
      toolTip="Used to identify peripheral interrupt" >
      <choice value="0"  enum="MessageBuffer" name="FlexCAN - Message Buffers (Mailboxes and FIFO)" />
      <choice value="1"  enum="BusOff"        name="FlexCAN - Bus off" />
      <choice value="2"  enum="Error"         name="FlexCAN - Error" />
      <choice value="3"  enum="TxWarning"     name="FlexCAN - Transmit Warning" />
      <choice value="4"  enum="RxWarning"     name="FlexCAN - Receive Warning" />
      <choice value="5"  enum="WakeUp"        name="FlexCAN - Wakeup" />
   </choiceOption>

   <constant key="irq_parameters"            type="String"  value="&quot;&quot;"  />
   <constant key="irq_dummy_parameters"      type="String"  value="&quot;&quot;"  />
   <constant key="irq_call"                  type="String"  value="&quot;&quot;"  />
   <constant key="generateDefault"           type="Boolean" value="false"         />
   <constant key="configureInStartupDefault" type="Boolean" value="false"         />
   <xi:include href="enablePeripheral.xml"  />
   <title />

<!--
    * General substitutions
    *  $(_NAME)         => e.g FTM2 => FTM2
    *  $(_name)         => e.g FTM2 => ftm2
    *  $(_BASENAME)     => e.g FTM0 => FTM, PTA => PT
    *  $(_basename)     => e.g FTM0 => ftm, PTA => pt
    *  $(_Class)        => e.g FTM2 => Ftm2
    *  $(_Baseclass)    => e.g FTM0 => Ftm
    *  $(_instance)     => e.g FTM0 => 0, PTA => A
-->

<!--
    * Template substitutions
    *
    * <li>%paramExpression            Parameters ORed together e.g. adcPretrigger|adcRefSel
    * <li>%valueExpression            Numeric variable value e.g. 0x3
    * <li>%symbolicExpression[index]  Symbolic formatted value e.g. AdcCompare_Disabled
    * <li>%variable[index]            Variable name /ADC0/adc_sc2_acfe
    * <li>%macro[index](value)        C register macro e.g. ADC_SC2_ACFGT(value)
    * <li>%description[index]         Description from controlVar e.g. Compare Function Enable
    * <li>%shortDescription[index]    Short description from controlVar e.g. Compare Function Enable
    * <li>%tooltip[index]             Tool-tip from controlVar e.g. Each bit disables the GPIO function
    * <li>%params                     Formatted parameter list for function
    * <li>%paramDescription[index]    Tool-tip from controlVar formatted as param description @param ...
    * <li>%paramType[index]           Based on typeName e.g. AdcCompare (or uint32_t)
    * <li>%paramName[index]           Based on typeName with lower-case first letter adcCompare
    * <li>%fieldAssignment            Expression of form '%register <= (%register & ~%mask)|%paramExpression
    * <li>%maskingExpression          Based on variable etc. Similar to (%register&%mask)
    * <li>%mask[index]                From &lt;mask&gt; or deduced from &lt;controlVarName&gt; e.g. "SIM_SOPT_REG_MASK" (_MASK is added)
    * <li>%register[index]            Register associated with variable e.g. adc->APCTL1
    * <li>%registerName[index]        Name of corresponding register (lowercase for Init()) e.g. apctl1
    * <li>%registerNAME[index]        Name of corresponding register (uppercase for Init()) e.g. APCTL1 <br><br>
-->

   <!-- ************* Class Declaration ****************** -->
   <constant key="_class_declaration" type="String"
      value="&quot;$(_Class)Info : public $(_Structname)BasicInfo&quot;" />

   <!-- Note: second entry gets the tick irrespective of true/false value -->
   <binaryOption key="EnableFifo"
      enabledBy="enablePeripheralSupport"
      description="Enable Receive FIFO"
      toolTip="This option enables use of the receive FIFO in addition to the individual mailboxes.\n
               The maximum number of individual mailboxes is reduced" >
      <choice value="0" name="Disabled" />
      <choice value="1" name="Enabled"  isDefault="true" />
   </binaryOption>

   <intOption key="MaxNumberOfMessageBuffers"
      enabledBy="enablePeripheralSupport"
      description="Maximum number of message buffers available"
      toolTip="This is the maximum value determined by the hardware.\n
               The CAN memory is shared between the FIFO filters and message buffers so\n
               the actual number available will be reduced by use of the FIFO and FIFO filters"
      locked="true"
      value="16" />

   <intOption key="MaxNumberOfFifoMessageFilters"
      enabledBy="enablePeripheralSupport"
      description="Maximum number of FIFO message filters available"
      toolTip="This is the maximum value determined by the hardware.\n
               The CAN memory is shared between the FIFO filters and message buffers\n
               so a usable number will be less than this"
      locked="true"
      value="40" />

   <intOption key="NumberOfFifoMessageFilters"
      enabledBy="enablePeripheralSupport"
      description="Number of filters for FIFO"
      toolTip="Used to configure number of FIFO filters"
      value="16" step="8" min="0" max="40" />

   <intOption key="NumberOfIndividualMailboxes"
      enabledBy="enablePeripheralSupport"
      description="Number of individual Rx/Tx mailboxes"
      toolTip="Used to configure number individually allocated mailboxes"
      value="8" min="0" max="16" />

   <template><![CDATA[
       \t//! Whether FIFO is enable
       \tstatic constexpr bool EnableFifo     =  $(EnableFifo);

       \t//! Maximum number of Message Buffers
       \tstatic constexpr unsigned MaxNumberOfMessageBuffers     =  $(MaxNumberOfMessageBuffers);

       \t//! Maximum number of Message Filters
       \tstatic constexpr unsigned MaxNumberOfFifoMessageFilters =  $(EnableFifo)?$(MaxNumberOfFifoMessageFilters):0;

       \t//! Number of Mailbox Buffers
       \tstatic constexpr unsigned NumberOfIndividualMailboxes   =  $(NumberOfIndividualMailboxes);

       \t//! Number of FIFO Message Filters
       \tstatic constexpr unsigned NumberOfFifoMessageFilters    =  $(EnableFifo)?$(NumberOfFifoMessageFilters):0;\n\n
   ]]></template>

   <irqOption key="miscellaneousIrqHandlingMethod"
      enabledBy="irqHandlingMethod"
      description="Miscellaneous Interrupt handlers"
      toolTip="This selection allow the interrupt handler for this peripheral to be installed using several different methods\n
               Handles: Bus Off, Transmit and Receive Warning"
      pattern="^%b%i_(BusOff|TxWarning|RxWarning)$"
      classHandler="%c%i::irqHandler" />

   <irqOption key="errorIrqHandlingMethod"
      enabledBy="irqHandlingMethod"
      description="Error Interrupt handlers"
      toolTip="This selection allow the interrupt handler for this peripheral to be installed using several different methods\n
               Handles: Bus Error"
      pattern="^%b%i_Error$"
      classHandler="%c%i::errorIrqHandler" />

   <irqOption key="wakeupIrqHandlingMethod"
      enabledBy="irqHandlingMethod"
      description="Wakeup Interrupt handlers"
      toolTip="This selection allow the interrupt handler for this peripheral to be installed using several different methods\n
               Handles: Wakeup"
      pattern="^%b%i_WakeUp$"
      classHandler="%c%i::wakeupIrqHandler" />

   <irqOption key="messagebufferIrqHandlingMethod"
      enabledBy="irqHandlingMethod"
      description="Message Buffer Interrupt handlers"
      toolTip="This selection allow the interrupt handler for this peripheral to be installed using several different methods\n
               Handles: Message buffer events (FIFO and Mailboxes)"
      pattern="^%b%i_MessageBuffer.*$"
      classHandler="%c%i::messageBufferIrqHandler" />

   <signals/>

   <choiceOption key="can_ctrl1_clksrc"
      typeName="CanClockSource"
      description="FlexCAN Clock"
      toolTip="Selects the clock source for the CAN interface" >
      <choice value="0"  name="OSCERCLK Clock" enum="OscerClk"  code="Osc0Info::getOscerClock()" />
      <choice value="1"  name="Bus clock"      enum="BusClk"    code="SystemBusClock"            />
   </choiceOption>

   <clockCodeTemplate variable="can_ctrl1_clksrc"
   returnFormat="%s"
   ><![CDATA[
      \t/**
      \t * Set %description
      \t *
      \t * @param %paramName %tooltip
      \t */
      \tstatic void setCanClock(%paramType %paramName) {
      \t   %fieldAssignment;
      \t}
      \t
      \t/**
      \t * Get %description
      \t *
      \t * @return Clock frequency in Hz
      \t */
      \tstatic uint32_t getCanClock() {
      \t
      \t   switch(%maskingExpression) {
      \t      default: return 0;
      %body
      \t   }
      \t}\n\n
   ]]></clockCodeTemplate>

   <template><![CDATA[
      \t/**
      \t * Get Protocol Engine input clock frequency
      \t *
      \t * @param clksrc value for CAN_CTRL1_CLKSRC
      \t *
      \t * @return CAN input clock frequency as a uint32_t in Hz
      \t */
      \tstatic uint32_t getPeClockFrequency(CanClockSource clksrc) {
      \t   if (clksrc) {
      \t      return SystemBusClock;
      \t   }
      \t   else {
      \t      return Osc0Info::getOscerClock();
      \t   }
      \t}

      \t/**
      \t * Get Protocol Engine input clock frequency
      \t *
      \t * @return CAN input clock frequency as a uint32_t in Hz
      \t */
      \tstatic uint32_t getPeClockFrequency() {
      \t    return getPeClockFrequency((CanClockSource)(can->CTRL1 & CAN_CTRL1_CLKSRC_MASK));
      \t}\n\n
   ]]></template>

   <template><![CDATA[
      \t/**
      \t * Get Controller Host Interface input clock frequency
      \t *
      \t * @return Input clock frequency as a uint32_t in Hz
      \t */
      \tstatic uint32_t getChiClockFrequency() {
      \t   return SystemCoreClock;
      \t}\n\n
   ]]></template>

   <template codeGenCondition="irqHandlingMethod" ><![CDATA[
      \t/**
      \t * Enable Miscellaneous interrupts in NVIC
      \t */
      \tstatic void enableMiscellaneousNvicInterrupts() {
      \t   NVIC_EnableIRQ(irqNums[$(_Class)IrqNum_BusOff]);
      \t   NVIC_EnableIRQ(irqNums[$(_Class)IrqNum_TxWarning]);
      \t   NVIC_EnableIRQ(irqNums[$(_Class)IrqNum_RxWarning]);
      \t}
      \t
      \t/**
      \t * Enable and set priority of Miscellaneous interrupts in NVIC
      \t * Any pending NVIC interrupts are first cleared.
      \t *
      \t * @param[in]  nvicPriority  Interrupt priority
      \t */
      \tstatic void enableMiscellaneousNvicInterrupts(uint32_t nvicPriority) {
      \t   enableNvicInterrupt(irqNums[$(_Class)IrqNum_BusOff], nvicPriority);
      \t   enableNvicInterrupt(irqNums[$(_Class)IrqNum_TxWarning], nvicPriority);
      \t   enableNvicInterrupt(irqNums[$(_Class)IrqNum_RxWarning], nvicPriority);
      \t}
      \t
      \t/**
      \t * Disable Miscellaneous interrupts in NVIC
      \t */
      \tstatic void disableMiscellaneousNvicInterrupts() {
      \t   NVIC_DisableIRQ(irqNums[$(_Class)IrqNum_BusOff]);
      \t   NVIC_DisableIRQ(irqNums[$(_Class)IrqNum_TxWarning]);
      \t   NVIC_DisableIRQ(irqNums[$(_Class)IrqNum_RxWarning]);
      \t}
      \t\n
   ]]></template>

   <!--   ========== class $(_Structname)BasicInfo =============================== -->

   <template namespace="baseClass" ><![CDATA[
      class $(_Structname)BasicInfo {

      public:\n
   ]]></template>

   <!--   ========== Interrupt handling =============================== -->

   <template namespace="baseClass" codeGenCondition="/$(_STRUCTNAME)/generateSharedIrqInfo" >
   <![CDATA[
      \t/**
      \t * Type for Secured Digital Host Controller call back function.
      \t */
      \ttypedef void (*CallbackFunction)();
      \t
      \t/**
      \t * Callback to catch unhandled interrupt
      \t */
      \tstatic void unhandledCallback($(irq_dummy_parameters)) {
      \t   setAndCheckErrorCode(E_NO_HANDLER);
      \t}
      \t\n
   ]]>
   </template>

   <template codeGenCondition="irqHandlingMethod" >
   <![CDATA[
      \t/** Callback function for Secured Digital Host Controller */
      \tstatic CallbackFunction callbackFunction;
      \t
      \t/**
      \t * Secured Digital Host Controller interrupt handler
      \t * Passes control to call-back function
      \t */
      \tstatic void irqHandler() {
      \t
      \t   // Execute call-back
      \t   callbackFunction($(irq_call));
      \t}
      \t
      \t/**
      \t * Set Secured Digital Host Controller callback function.
      \t *
      \t * @param      $(_basename)Callback Callback function to execute on interrupt
      \t *                             Use nullptr to remove callback.
      \t */
      \tstatic void setCallback(CallbackFunction $(_basename)Callback) {
      \t   if ($(_basename)Callback == nullptr) {
      \t      $(_basename)Callback = (CallbackFunction)unhandledCallback;
      \t   }
      \t   // Allow either no handler set yet or removing handler
      \t   usbdm_assert(
      \t         ((void*)callbackFunction == (void*)unhandledCallback) ||
      \t         ((void*)$(_basename)Callback == (void*)unhandledCallback),
      \t         "Handler already set");
      \t   callbackFunction = $(_basename)Callback;
      \t}
      \t
      \t\n
   ]]>
   </template>

   <template key="/HARDWARE/StaticObjects" codeGenCondition="irqHandlingMethod" >
   <![CDATA[
      \t/**
      \t * Callback function for Secured Digital Host Controller
      \t */
      \t$(_Class)Info::CallbackFunction $(_Class)Info::callbackFunction = (CallbackFunction)$(_Class)Info::unhandledCallback;
      \t
      \t\n
   ]]>
   </template>


<!--   Default Initialisation value -->


<!--   Configure methods -->




   <template where="basicInfo" >
   <![CDATA[
      }; // class $(_Structname)BasicInfo
      \t\n
   ]]>
   </template>

   <!-- ************* Common ****************** -->

   <template key="/$(_BASENAME)/declarations" codeGenCondition="enablePeripheralSupport" >
   <![CDATA[
      \t/**
      \t * Class representing $(_NAME)
      \t */
      \tusing $(_Class) = $(_Baseclass)Handler_T<$(_Class)Info>;
   ]]>
   </template>

   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.PeripheralValidator" >
   </validate>

   <projectActionList id="can_files" >
      <copy source="Project_Headers/can-MK.h"                    target="Project_Headers/can.h"                    overwrite="true"  derived="true" />
      <copy source="Snippets/can-mailbox-example.cpp"         target="Snippets/can-mailbox-example.cpp"         overwrite="true"  derived="true" />
      <copy source="Snippets/can-sw-led-example.cpp"          target="Snippets/can-sw-led-example.cpp"          overwrite="true"  derived="true" />
      <copy source="Snippets/can-fifo-example.cpp"            target="Snippets/can-fifo-example.cpp"            overwrite="true"  derived="true" />
   </projectActionList>

   <!-- ************* Startup ****************** -->

   <template key="/SYSTEM/Includes" condition="configurePeripheralInStartUp" codeGenCondition="configurePeripheralInStartUp" >
      <![CDATA[#include "$(_basename).h"\n
   ]]></template>

   <template key="/SYSTEM/Startup" condition="configurePeripheralInStartUp" codeGenCondition="configurePeripheralInStartUp" >
   <![CDATA[
      \t/*  Initialise $(_Class) */
      \tUSBDM::$(_Class)::defaultConfigure();\n
   ]]></template>

   <!-- ************* SIM configuration ****************** -->
   <category name="Advanced" description="SIM configuration" >
      <aliasOption key="=_scgc_clock" locked="false" condition="_scgc_clock" />
      <for keys="v" values="=/SIM/$(_Class)ExternalItems" condition="/SIM/$(_Class)ExternalItems" >
         <aliasOption key="/SIM/%(v)"           optional="true" locked="false" />
      </for>
   </category>
   <deleteVariables variables="_scgc_clock"  mustExist="false" />

   <!-- ************* Signal mapping ****************** -->
   <signals enabledBy="enablePeripheralSupport" locked="!/PCR/_present" />

</peripheralPage>
