<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE fragment SYSTEM "_menu.dtd" >
<!-- ftm_quadrature_decoder.xml -->

<fragment xmlns:xi="http://www.w3.org/2001/XInclude" >

<!--
    * General substitutions
    *  $(_NAME)         => e.g FTM2 => FTM2
    *  $(_name)         => e.g FTM2 => ftm2
    *  $(_BASENAME)     => e.g FTM0 => FTM, PTA => PT
    *  $(_basename)     => e.g FTM0 => ftm, PTA => pt
    *  $(_Class)        => e.g FTM2 => Ftm2
    *  $(_Baseclass)    => e.g FTM0 => Ftm
    *  $(_instance)     => e.g FTM0 => 0, PTA => A
-->

<!--
    * Template substitutions
    *
    * <li>%paramExpression            Parameters ORed together e.g. adcPretrigger|adcRefSel
    * <li>%valueExpression            Numeric variable value e.g. 0x3
    * <li>%symbolicExpression[index]  Symbolic formatted value e.g. AdcCompare_Disabled
    * <li>%variable[index]            Variable name /ADC0/adc_sc2_acfe
    * <li>%macro[index](value)        C register macro e.g. ADC_SC2_ACFGT(value)
    * <li>%description[index]         Description from controlVar e.g. Compare Function Enable
    * <li>%shortDescription[index]    Short description from controlVar e.g. Compare Function Enable
    * <li>%tooltip[index]             Tool-tip from controlVar e.g. Each bit disables the GPIO function
    * <li>%params                     Formatted parameter list for function
    * <li>%paramDescription[index]    Tool-tip from controlVar formatted as param description @param ...
    * <li>%paramType[index]           Based on typeName e.g. AdcCompare (or uint32_t)
    * <li>%paramName[index]           Based on typeName with lower-case first letter adcCompare
    * <li>%fieldAssignment            Expression of form '%register <= (%register & ~%mask)|%paramExpression
    * <li>%maskingExpression          Based on variable etc. Similar to (%register&%mask)
    * <li>%variable[index]            Variable name
    * <li>%mask[index]                From &lt;mask&gt; or deduced from &lt;controlVarName&gt; e.g. "SIM_SOPT_REG_MASK" (_MASK is added)
    * <li>%register[index]            Register associated with variable e.g. adc->APCTL1
    * <li>%registerName[index]        Name of corresponding register (lowercase for Init()) e.g. apctl1
    * <li>%registerNAME[index]        Name of corresponding register (uppercase for Init()) e.g. APCTL1 <br><br>
-->

<!--  ==== FTM QUAD Controls =============================== -->

   <list key="quadDecoder" condition="ftm_qdctrl_quadmode_present&amp;&amp;_control"
      description="Quadrature decoder"
      hiddenBy="mode!=Quad" >
      
      <title description="Quadrature Decoder" />
      
      <binaryOption key="ftm_qdctrl_quadmode" condition="ftm_qdctrl_quadmode_present"
         enabledBy="enablePeripheralSupport"
         typeName="FtmQuadratureMode"
         description="Quadrature decoding mode"
         toolTip="Determines how the inputs control the counting sequence" >
         <choice value="0" name="Phase-AB Mode"         enum="Phase_AB_Mode" />
         <choice value="1" name="Count-Direction Mode"  enum="Count_Direction_Mode"  />
      </binaryOption>
   
      <title name="Channel A" description="Channel A" condition="ftm_qdctrl_phapol_present" />
      <binaryOption key="ftm_qdctrl_phapol" condition="ftm_qdctrl_phapol_present"
         enabledBy="enablePeripheralSupport"
         typeName="FtmPhaseAPolarity"
         description="Polarity of Phase A input"
         toolTip="Polarity of Phase A input" >
         <choice value="0" name="Active High" enum="ActiveHigh" />
         <choice value="1" name="Active Low"  enum="ActiveLow"  />
      </binaryOption>
   
      <choiceOption key="ftm_qdfilter_a" condition="ftm_qdctrl_phafltren_present"
         enabledBy="enablePeripheralSupport"
         valueFormat="(FTM_QDCTRL_PHAFLTREN(%s)&lt;&lt;8),FTM_FILTER_CH0FVAL(%s)"
         enumType="uint16_t"
         typeName="FtmPhaseAFilter"
         description="Filtering on Phase A input"
         toolTip="Filtering on Phase A input" >
         <choice value="0,0"  name="No Filter"       enum="Disabled" />
         <choice value="1,1"  name="1 clock cycle"   enum="1_Clock"  />
         <choice value="1,2"  name="2 clock cycles"  enum="2_Clocks"  />
         <choice value="1,3"  name="3 clock cycles"  enum="3_Clocks"  />
         <choice value="1,4"  name="4 clock cycles"  enum="4_Clocks"  />
         <choice value="1,5"  name="5 clock cycles"  enum="5_Clocks"  />
         <choice value="1,6"  name="6 clock cycles"  enum="6_Clocks"  />
         <choice value="1,7"  name="7 clock cycles"  enum="7_Clocks"  />
         <choice value="1,8"  name="8 clock cycles"  enum="8_Clocks"  />
         <choice value="1,9"  name="9 clock cycles"  enum="9_Clocks"  />
         <choice value="1,10" name="10 clock cycles" enum="10_Clocks" />
         <choice value="1,11" name="11 clock cycles" enum="11_Clocks" />
         <choice value="1,12" name="12 clock cycles" enum="12_Clocks" />
         <choice value="1,13" name="13 clock cycles" enum="13_Clocks" />
         <choice value="1,14" name="14 clock cycles" enum="14_Clocks" />
         <choice value="1,15" name="15 clock cycles" enum="15_Clocks" />
      </choiceOption>
   
      <title name="Channel B" description="Channel B" condition="ftm_qdctrl_phbpol_present" />
      <binaryOption key="ftm_qdctrl_phbpol" condition="ftm_qdctrl_phbpol_present"
         enabledBy="enablePeripheralSupport"
         typeName="FtmPhaseBPolarity"
         description="Polarity of Phase B input"
         toolTip="Polarity of Phase B input" >
         <choice value="0" name="Active High" enum="ActiveHigh" />
         <choice value="1" name="Active Low"  enum="ActiveLow"  />
      </binaryOption>
   
      <choiceOption key="ftm_qdfilter_b" condition="ftm_qdctrl_phbfltren_present"
         enabledBy="enablePeripheralSupport"
         valueFormat="(FTM_QDCTRL_PHBFLTREN(%s)&lt;&lt;8),FTM_FILTER_CH1FVAL(%s)"
         enumType="uint16_t"
         typeName="FtmPhaseBFilter"
         description="Filtering on Phase B input"
         toolTip="Filtering on Phase B input" >
         <choice value="0,0"  name="No Filter"       enum="Disabled" />
         <choice value="1,1"  name="1 clock cycle"   enum="1_Clock"  />
         <choice value="1,2"  name="2 clock cycles"  enum="2_Clocks"  />
         <choice value="1,3"  name="3 clock cycles"  enum="3_Clocks"  />
         <choice value="1,4"  name="4 clock cycles"  enum="4_Clocks"  />
         <choice value="1,5"  name="5 clock cycles"  enum="5_Clocks"  />
         <choice value="1,6"  name="6 clock cycles"  enum="6_Clocks"  />
         <choice value="1,7"  name="7 clock cycles"  enum="7_Clocks"  />
         <choice value="1,8"  name="8 clock cycles"  enum="8_Clocks"  />
         <choice value="1,9"  name="9 clock cycles"  enum="9_Clocks"  />
         <choice value="1,10" name="10 clock cycles" enum="10_Clocks" />
         <choice value="1,11" name="11 clock cycles" enum="11_Clocks" />
         <choice value="1,12" name="12 clock cycles" enum="12_Clocks" />
         <choice value="1,13" name="13 clock cycles" enum="13_Clocks" />
         <choice value="1,14" name="14 clock cycles" enum="14_Clocks" />
         <choice value="1,15" name="15 clock cycles" enum="15_Clocks" />
      </choiceOption>
   </list>

<!--  ==== FTM QUAD Init class =============================== -->

   <if condition="ftm_qdctrl_quadmode_present&amp;&amp;_code" >

      <template where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo" ><![CDATA[
         \t/**
         \t * Class used to do initialisation of Ftm QuadDecoder
         \t *
         \t * This class has a templated constructor that accepts various values:
         \t *
         \t * @note This constructor may be used to create a const instance in ROM
         \t *
         \t * Example:
         \t * @code
         \t * static const FtmQuadDecoder$(_instance)::QuadInit quadInit {
         \t *
         \t *    // Omitted parameters are taken to be zero unless a base value is given
         \t *    FtmQuadratureMode_Phase_AB_Mode , // Quadrature decoding mode
         \t *    FtmPhaseAPolarity_ActiveHigh ,    // Polarity of Phase A input
         \t *    FtmPhaseBPolarity_ActiveHigh ,    // Polarity of Phase B input
         \t *    FtmPhaseAFilter_Disabled ,        // Filtering on Phase A input
         \t *    FtmPhaseBFilter_Disabled ,        // Filtering on Phase B input
         \t *    FtmOverflowInterrupt_Enabled ,    // Overflow Interrupt
         \t *    FtmPrescale_DivBy32,              // Clock prescaler
         \t *    30000_ticks,                      // End value for counter
         \t *
         \t *    NvicPriority_Normal ,             // IRQ level for this peripheral
         \t *    ftmCallbak,                       // Timer overflow call-back
         \t *
         \t *    // Optional base value to start with (must be last parameter)
         \t *    FtmQuadDecoder$(_instance)::DefaultQuadInitValue
         \t * };
         \t *
         \t * // Initialise FTM from values specified above
         \t * FtmQuadDecoder$(_instance)::configure(quadInit)
         \t * @endcode
         \t */
         \tclass QuadInit {
         \t
         \tpublic:
         \t   /**
         \t    * Copy Constructor
         \t    */
         \t   constexpr QuadInit(const QuadInit &other) = default;
         \t
         \t   /**
         \t    * Default Constructor
         \t    */
         \t   constexpr QuadInit() = default;
         \t\n
      ]]></template>

      <!-- QUAD Init class Member variables -->

   <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedIrqInfo"
         variables="irqHandlingMethod"
       ><![CDATA[
         \t   // %description
         \t   %params = nullptr;\n\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_qdfilter_a,ftm_qdfilter_b"
      ><![CDATA[
         \t   // Quad input filter control
         \t   uint16_t %registerName = 0;\n\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_qdctrl_quadmode"
      ><![CDATA[
         \t   // Quadrature Decoder Control And Status Register
         \t   uint8_t %registerName = FTM_QDCTRL_QUADEN_MASK;\n\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_sc_action,ftm_sc_ps"
      ><![CDATA[
         \t   // Status And Control Register
         \t   uint8_t %registerName = 0;\n\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_mod"
      ><![CDATA[
         \t   // %description
         \t   uint16_t %registerName = 0_ticks;\n\n
      ]]></variableTemplate>
   
      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedIrqInfo"
         variables="/PCR/nvic_irqLevel"
      ><![CDATA[
         \t   // %description
         \t   %paramType %registerName = %paramType_Normal;\n\n
      ]]></variableTemplate>

      <!-- QUAD Init class Constructors -->

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedIrqInfo"
         variables="irqHandlingMethod"
         linePadding="xxx"
       ><![CDATA[
         \t   /**
         \t    * Constructor for %description
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr QuadInit(%params, Types... rest) : QuadInit(rest...) {
         \t
         \t      this->%paramName0 = %paramExpression;
         \t   }\n\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedIrqInfo"
         variables="/PCR/nvic_irqLevel"
         linePadding="xxx"
       ><![CDATA[
         \t   /**
         \t    * Constructor for %description
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr QuadInit(%params, Types... rest) : QuadInit(rest...) {
         \t
         \t      %registerName = %paramExpression;
         \t   }\n\n
      ]]></variableTemplate>

      <for keys="r" values="
         ftm_sc_action;
         ftm_qdctrl_quadmode;
         ftm_qdctrl_phapol;
         ftm_qdctrl_phbpol" >
         <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
            variables="%(r)"
            linePadding="xxx"
         ><![CDATA[
            \t   /**
            \t    * Constructor for %description
            \t    *
            \t    * @tparam   Types
            \t    * @param    rest
            %paramDescription
            \t    */
            \t   template <typename... Types>
            \t   constexpr QuadInit(%params, Types... rest) : QuadInit(rest...) {
            \t
            \t      %registerName = (%registerName&~%mask) | %paramExpression;
            \t   }
            \t\n
         ]]></variableTemplate>
      </for>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_sc_ps, ftm_mod"
         params=",mod_ticks"
         linePadding="xxx"
         nonDefaultParams="2"
      ><![CDATA[
         \t   /**
         \t    * Constructor for %description0 and %description1
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         \t    *
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr QuadInit(
         %params, Types... rest) : QuadInit(rest...) {
         \t
         \t      %registerName0    = (%registerName0&~%mask0) | %paramName0;
         \t      %registerName1   = %paramName1;
         \t   }
         \t\n
      ]]></variableTemplate>
   
      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_qdfilter_a"
         linePadding="xxx"
      ><![CDATA[
         \t   /**
         \t    * Constructor for %description
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr QuadInit(%params, Types... rest) : QuadInit(rest...) {
         \t
         \t      qdctrl   = (qdctrl&~FTM_QDCTRL_PHAFLTREN_MASK) | ((%paramExpression>>8) & FTM_QDCTRL_PHAFLTREN_MASK);
         \t      qdfilter = (qdfilter&~FTM_FILTER_CH0FVAL_MASK) | (%paramExpression&FTM_FILTER_CH0FVAL_MASK);
         \t   }
         \t\n
      ]]></variableTemplate>

      <variableTemplate where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo"
         variables="ftm_qdfilter_b"
         linePadding="xxx"
      ><![CDATA[
         \t   /**
         \t    * Constructor for %description
         \t    *
         \t    * @tparam   Types
         \t    * @param    rest
         %paramDescription
         \t    */
         \t   template <typename... Types>
         \t   constexpr QuadInit(%params, Types... rest) : QuadInit(rest...) {
         \t
         \t      qdctrl   = (qdctrl&~FTM_QDCTRL_PHBFLTREN_MASK) | ((%paramExpression>>8) & FTM_QDCTRL_PHBFLTREN_MASK);
         \t      qdfilter = (qdfilter&~FTM_FILTER_CH1FVAL_MASK) | (%paramExpression&FTM_FILTER_CH1FVAL_MASK);
         \t   }
         \t\n
      ]]></variableTemplate>

      <template where="basicInfo" codeGenCondition="/$(_STRUCTNAME)/generateSharedInfo" ><![CDATA[
         \t};
         \t\n
      ]]></template>

   <!--  Default QuadInitValue value -->

      <template namespace="all" key="/$(_BASENAME)/quadinit_reference" 
         codeGenCondition="enablePeripheralSupport&amp;&amp;(mode==Quad)" ><![CDATA[
         \tusing Info::DefaultQuadInitValue;
         \t\n
      ]]></template>

      <variableTemplate codeGenCondition="enablePeripheralSupport&amp;&amp;(mode==Quad)"
         separator=","
         terminator=","
         variables="
            ftm_qdctrl_quadmode,
            ftm_qdctrl_phapol,
            ftm_qdctrl_phbpol,
            ftm_qdfilter_a,
            ftm_qdfilter_b,
            ftm_sc_action,
            ftm_sc_ps,
            ftm_mod"
      ><![CDATA[
         \t/**
         \t * Default initialisation value for $(_Class)QuadDecoder
         \t * This value is created from Configure.usbdmProject settings
         \t */
         \tstatic constexpr QuadInit DefaultQuadInitValue = {%initExpression
         \t};\n\n
      ]]></variableTemplate>

      <!-- QUAD Init class Configure method -->

      <template codeGenCondition="enablePeripheralSupport" ><![CDATA[
         \t/**
         \t * Configure QuadDecoder from values specified in init
         \t
         \t * @param quadInit Class containing initialisation values
         \t */
         \tstatic ErrorCode configure(const QuadInit &quadInit) {
         \t
         \t   // Enable peripheral clock
         \t   enableClock();\n\n
      ]]></template>
      <template codeGenCondition="irqHandlingMethod" ><![CDATA[
         \t   // Only set call-back if feature enabled and non-null
         \t   if (quadInit.callbackFunction != nullptr) {
         \t      setCallback(quadInit.callbackFunction);
         \t   }
         \t   enableNvicInterrupt(irqNums[0], quadInit.irqlevel);\n
      ]]></template>
      <template codeGenCondition="enablePeripheralSupport" ><![CDATA[
         \t
         \t   // Disable timer to change clock (unable to switch directly between clock sources)
         \t   ftm->SC  = 0;
         \t
         \t   // Start value for counter
         \t   ftm->CNTIN = 0;
         \t
         \t   // End value for counter
         \t   ftm->MOD = quadInit.mod;
         \t
         \t   // Restart counter
         \t   ftm->CNT = 0;
         \t
         \t   // Configure timer
         \t   ftm->FILTER = quadInit.qdfilter;
         \t   ftm->SC     = quadInit.sc;
         \t   ftm->QDCTRL = quadInit.qdctrl;
         \t
         \t   return E_NO_ERROR;
         \t}\n\n
      ]]></template>

   </if> <!-- condition="ftm_qdctrl_quadmode_present" -->

<!--  ==== FTM QUAD Declarations =============================== -->

   <template key="/$(_BASENAME)/quadDeclarations" condition="_declaration" ><![CDATA[
   \t/**
   \t * Class representing $(_Class) as Quadrature decoder
   \t */
   \ttypedef $(_Baseclass)QuadDecoder_T<$(_Class)Info> $(_Baseclass)QuadDecoder$(_instance);\n
   ]]></template>

</fragment>
