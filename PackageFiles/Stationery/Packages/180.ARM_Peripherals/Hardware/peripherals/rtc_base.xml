<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fragment SYSTEM "_menu.dtd" >
<!-- rtc_base.xml -->

<fragment xmlns:xi="http://www.w3.org/2001/XInclude" >

   <xi:include href="_mapPinsOption_on.xml"/>
   <xi:include href="_default_instance.xml"/>

   <binaryOption key="configure_rtc"
      description="Configure RTC"
      toolTip="Enables configuration of RTC during startup  \n
               If disabled no RTC registers are accessed">
      <choice value="0" name="Disabled" />
      <choice value="1" name="Enabled" isDefault="true" />
   </binaryOption>

   <category name="ERCLK32K Selection" description="Control source of ERCLK32K clock (nominally 32kHz)">
      <aliasOption key="/PMC/system_low_power_clock"  optional="true" />
      <aliasOption key="/SIM/rtc_clkin_clock"         optional="true" constant="false" />
      <aliasOption key="/SIM/sim_sopt1_osc32ksel"     optional="true" constant="false" />
      <aliasOption key="/SIM/system_erclk32k_clock"   optional="true" />
   </category>

   <binaryOption key="rtc_cr_osce"
      description="Enable RTC oscillator"
      toolTip="Enable 32kHz RTC oscillator">
      <choice value="0" name="Disabled" isDefault="true" />
      <choice value="1" name="Enabled" />
   </binaryOption>

   <intOption key="osc_input_freq"
      enabledBy="rtc_cr_osce"
      units="Hz"
      description="32kHz clock"
      origin="RTC Clock"
      toolTip="Frequency of RTC Crystal on XTAL32/EXTAL32"
      value="32768"
      disabledValue="0"
      min="32000" max="40000" />

   <choiceOption key="rtc_cr_scp"
      enabledBy="rtc_cr_osce"
      description="Oscillator load capacitance"
      toolTip="Configures the oscillator load capacitance" >
      <choice value="0"  name="0 pF" />
      <choice value="8"  name="2 pF" />
      <choice value="4"  name="4 pF" />
      <choice value="12" name="6 pF" />
      <choice value="2"  name="8 pF" isDefault="true" />
      <choice value="10" name="10 pF" />
      <choice value="6"  name="12 pF" />
      <choice value="14" name="14 pF" />
      <choice value="1"  name="16 pF" />
      <choice value="9"  name="18 pF" />
      <choice value="5"  name="20 pF" />
      <choice value="13" name="22 pF" />
      <choice value="3"  name="24 pF" />
      <choice value="11" name="26 pF" />
      <choice value="7"  name="28 pF" />
      <choice value="15" name="30 pF" />
   </choiceOption>

   <intOption key="osc_clock"
      enabledBy="rtc_cr_osce"
      ref="osc_input_freq"
      description="RTC oscillator clock"
      toolTip="Output of RTC oscillator and input to RTC counters"
      derived="true"
      constant="true"
      units="Hz"
      disabledValue="0" />

   <stringOption key="Note" constant="true" derived="true" />

   <binaryOption key="rtc_cr_clko"
      enabledBy="rtc_cr_osce"
      description="Enable RTC 32kHz Clock Output"
      toolTip="Determines if RTC 32kHz Clock is available to peripherals" >
      <choice value="1" name="Clock not output to peripherals" />
      <choice value="0" name="Clock is output to peripherals" isDefault="true" />
   </binaryOption>

   <intOption key="rtcclk_gated_clock"
      enabledBy="rtc_cr_clko, Disabled by rtc_cr_clko"
      ref="osc_clock"
      derived="true"
      constant="true"
      units="Hz"
      description="Frequency of RTC Peripheral Clock"
      toolTip="RTC clock available to peripherals"
      value="0" />

   <intOption key="rtc_1hz_clock"
      ref="(osc_clock)/32768.0"
      constant="true"
      derived="true"
      description="1Hz output from RTC"
      origin="RTC 1Hz output"
      units="Hz"/>

   <binaryOption key="rtc_cr_um"
      description="Update Mode"
      toolTip="Allows the SR[TCE] to be written even when the Status Register is locked.\n
               When set, the SR[TCE] can always be written if the SR[TIF] or SR[TOF] are set or if the SR[TCE] is clear" >
      <choice value="0" name="SR[TCE] cannot be written when locked" />
      <choice value="1" name="SR[TCE] can be written when locked under limited conditions" />
   </binaryOption>

   <binaryOption key="rtc_cr_sup"
      description="Supervisor access"
      toolTip="Determines if the RTC register access is available in non-supervisor mode \n
               Non supported write accesses generate a bus error" >
      <choice value="0" name="Non-supervisor write accesses not supported" />
      <choice value="1" name="Non-supervisor write accesses supported" />
   </binaryOption>

   <binaryOption key="rtc_cr_wpe"
      description="Wakeup Pin Enable"
      toolTip="Determines if the wakeup pin is asserted on RTC interrupt when powered down \n
               The wakeup pin is optional and not available on all devices" >
      <choice value="0" name="Wakeup pin is disabled" />
      <choice value="1" name="Wakeup pin is enabled" />
   </binaryOption>

   <aliasOption key="/SIM/sim_sopt2_rtcclkoutsel" optional="true" constant="false" />
   <aliasOption key="/SIM/rtc_clkout"             optional="true" />

   <template><![CDATA[
      \t//! Whether to configure RTC
      \t//! If disabled then no RTC registers are accessed.
      \t//! This is useful if RTC is not powered as register access will trap.
      \tstatic constexpr bool configure_rtc = $(configure_rtc);
      \t
      \t//! Frequency of RTC External Clock or Crystal
      \tstatic constexpr uint32_t osc_input_freq = $(osc_input_freq)UL;
      \t\n
   ]]></template>

   <initialValueTemplate
      separator="|"
      terminator=";"
      variables="
            rtc_cr_osce,
            rtc_cr_clko,
            rtc_cr_um,
            rtc_cr_sup,
            rtc_cr_wpe,
            rtc_cr_scp"
   ><![CDATA[
      \t//! Oscillator control register
      \tstatic constexpr uint32_t cr = %initExpression
      \t\n
   ]]></initialValueTemplate>

   <intOption key="rtc_tcr_tcr" min="-128" max="127"
      description="Time Compensation Register"
      toolTip="Adjusts the number of 32.768 kHz clock cycles in each second.\n
               This value+32768 determines the number of clock cycles that makes up a second"
      value="0" />

   <intOption key="rtc_tcr_cir" min="1" max="256" offset="-1"
      enabledBy="rtc_tcr_tcr!=0"
      description="Compensation Interval Register"
      toolTip="Configures the compensation interval that controls how frequently the TCR adjustment value \n
         		is applied to alter the number of 32.768 kHz cycles in each second. \n
               This register is double buffered and writes do not take affect until the end of the current compensation interval"
      value="1"
      units="s" />

   <initialValueTemplate
      separator="|"
      terminator=";"
      variables="
            rtc_tcr_cir,
            rtc_tcr_tcr"
   ><![CDATA[
      \t//! RTC Time Compensation Register
      \tstatic constexpr uint32_t tcr = %initExpression
      \t\n
   ]]></initialValueTemplate>

   <category name="Register Locks" description="Locks RTC Registers">
	   <binaryOption key="rtc_lr_lrl"
	      description="Lock Register Lock"
	      toolTip="Once cleared, this bit can only be set by VBAT POR or software reset" >
	      <choice value="0" name="Locked" />
	      <choice value="1" name="Unlocked"  isDefault="true" />
	   </binaryOption>

	   <binaryOption key="rtc_lr_srl"
	      description="Status Register Lock"
	      toolTip="Once cleared, this bit can only be set by VBAT POR or software reset" >
	      <choice value="0" name="Locked" />
	      <choice value="1" name="Unlocked"  isDefault="true" />
	   </binaryOption>

	   <binaryOption key="rtc_lr_crl"
	      description="Control Register Lock"
	      toolTip="Once cleared, this bit can only be set by VBAT POR or software reset" >
	      <choice value="0" name="Locked" />
	      <choice value="1" name="Unlocked"  isDefault="true" />
	   </binaryOption>

	   <binaryOption key="rtc_lr_tcl"
	      description="Time Compensation Lock"
	      toolTip="Once cleared, this bit can only be set by VBAT POR or software reset" >
	      <choice value="0" name="Locked" />
	      <choice value="1" name="Unlocked"  isDefault="true" />
	   </binaryOption>
   </category>

   <initialValueTemplate
      separator="|"
      terminator=";"
      variables="
            rtc_lr_lrl,
            rtc_lr_srl,
            rtc_lr_crl,
            rtc_lr_tcl"
   ><![CDATA[
      \t//! RTC Lock Register
      \tstatic constexpr uint32_t lr = %initExpression
      \t\n
   ]]></initialValueTemplate>

   <category name="Write Access" description="Controls write access to RTC Registers">
      <binaryOption key="rtc_war_ierw" condition="rtc_war_ierw_present"
         description="Interrupt Enable Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_lrw" condition="rtc_war_lrw_present"
         description="Lock Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_srw" condition="rtc_war_srw_present"
         description="Status Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_crw" condition="rtc_war_crw_present"
         description="Control Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_tcrw" condition="rtc_war_tcrw_present"
         description="Time Compensation Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_tarw" condition="rtc_war_tarw_present"
         description="Time Alarm Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_tprw" condition="rtc_war_tprw_present"
         description="Time Prescaler Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_war_tsrw" condition="rtc_war_tsrw_present"
         description="Time Seconds Register Write"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Writes are ignored" />
         <choice value="1" name="Writes allowed"  isDefault="true" />
      </binaryOption>

      <initialValueTemplate
         separator="|"
         terminator=";"
         variables="
            rtc_war_ierw,
            rtc_war_lrw,
            rtc_war_srw,
            rtc_war_crw,
            rtc_war_tcrw,
            rtc_war_tarw,
            rtc_war_tprw,
            rtc_war_tsrw"
      ><![CDATA[
         \t//! RTC Write Access Register
         \tstatic constexpr uint32_t war = %initExpression
         \t\n
      ]]></initialValueTemplate>
   </category>

   <category name="Read Access" description="Controls read access to RTC Registers">
      <binaryOption key="rtc_rar_ierr" condition="rtc_rar_ierr_present"
         description="Interrupt Enable Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_lrr" condition="rtc_rar_lrr_present"
         description="Lock Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_srr" condition="rtc_rar_srr_present"
         description="Status Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_crr" condition="rtc_rar_crr_present"
         description="Control Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_tcrr" condition="rtc_rar_tcrr_present"
         description="Time Compensation Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_tarr" condition="rtc_rar_tarr_present"
         description="Time Alarm Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_tprr" condition="rtc_rar_tprr_present"
         description="Time Prescaler Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <binaryOption key="rtc_rar_tsrr" condition="rtc_rar_tsrr_present"
         description="Time Seconds Register Read"
         toolTip="Once cleared, this bit is only set by system reset. It is not affected by VBAT POR or software reset" >
         <choice value="0" name="Reads are ignored" />
         <choice value="1" name="Reads allowed"  isDefault="true" />
      </binaryOption>

      <initialValueTemplate
         separator="|"
         terminator=";"
         variables="
            rtc_rar_ierr,
            rtc_rar_lrr,
            rtc_rar_srr,
            rtc_rar_crr,
            rtc_rar_tcrr,
            rtc_rar_tarr,
            rtc_rar_tprr,
            rtc_rar_tsrr"
      ><![CDATA[
         \t//! RTC Read Access Register
         \tstatic constexpr uint32_t rar = %initExpression
         \t\n
      ]]></initialValueTemplate>
   </category>

   <stringOption key="irq_pattern"        constant="true" value="^RTC_(Alarm|Seconds)$" hidden="true" />
   <stringOption key="irq_classHandler"   constant="true" value="%c%i::irq$1Handler" hidden="true" />
   <xi:include href="_irqOptionSubstituted.xml"/>

   <rtcTimeOption key="rtc_coldstart_value"
      value="1672538401"
      description="Initial RTC time value."
      toolTip="Used for coldstart.\n
               This value is only used if the RTC is doing a power-on reset" />

   <intOption key="rtc_timezone" min="-13" max="+13" value="10"
      description="Time zone correction"
      toolTip="Applied to rtc_coldstart_value. \n
               Should include daylight saving offset" />

   <template><![CDATA[
      \t//! Time for cold start (corrected for time zone)
      \tstatic constexpr uint32_t coldStartTime =
      \t       $(rtc_coldstart_value) + $(rtc_timezone)*60*60;
      \t\n
    ]]></template>

   <category name="Device Registers (view only)" description="RTC Register values">
      <category name="RTC CR" description="RTC Control Register">
         <aliasOption key="rtc_cr_scp" />
         <aliasOption key="rtc_cr_clko" />
         <aliasOption key="rtc_cr_osce" />
         <aliasOption key="rtc_cr_um" />
         <aliasOption key="rtc_cr_sup" />
         <aliasOption key="rtc_cr_wpe" />
      </category>
      <category name="RTC LR" description="RTC Lock Register">
         <aliasOption key="rtc_lr_lrl" />
         <aliasOption key="rtc_lr_srl" />
         <aliasOption key="rtc_lr_crl" />
         <aliasOption key="rtc_lr_tcl" />
      </category>
      <category name="RTC TCR" description="RTC Time Compensation Register">
         <aliasOption key="rtc_tcr_cir" />
         <aliasOption key="rtc_tcr_tcr" />
      </category>
      <category name="RTC WAR" description="RTC Write Access Register">
         <aliasOption key="rtc_war_ierw" optional="true" />
         <aliasOption key="rtc_war_lrw"  optional="true" />
         <aliasOption key="rtc_war_srw"  optional="true" />
         <aliasOption key="rtc_war_crw"  optional="true" />
         <aliasOption key="rtc_war_tcrw" optional="true" />
         <aliasOption key="rtc_war_tarw" optional="true" />
         <aliasOption key="rtc_war_tprw" optional="true" />
         <aliasOption key="rtc_war_tsrw" optional="true" />
      </category>
      <category name="RTC RAR" description="RTC Read Access Register">
         <aliasOption key="rtc_rar_ierr" optional="true" />
         <aliasOption key="rtc_rar_lrr"  optional="true" />
         <aliasOption key="rtc_rar_srr"  optional="true" />
         <aliasOption key="rtc_rar_crr"  optional="true" />
         <aliasOption key="rtc_rar_tcrr" optional="true" />
         <aliasOption key="rtc_rar_tarr" optional="true" />
         <aliasOption key="rtc_rar_tprr" optional="true" />
         <aliasOption key="rtc_rar_tsrr" optional="true" />
      </category>
   </category>

   <template key="/RTC/declarations" namespace="all"  ><![CDATA[
      \t/**
      \t * Class representing $(_name)
      \t */
      \tclass $(_class) : public $(_base_class)Base_T<$(_class)Info> {};
   ]]></template>

   <template key="/MCG/Includes" namespace="all"  ><![CDATA[
      #include "rtc.h"\n
   ]]></template>

   <template key="/MCG/Initialisation" namespace="all"  ><![CDATA[
      \tUSBDM::$(_class)::initialise();\n
   ]]></template>

   <xi:include href="_clockOption.xml"/>

   <signals/>

   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.RtcValidate">
   </validate>

   <projectActionList id = "rtc_files" >
      <copy source="Project_Headers/rtc.h"       target="Project_Headers/rtc.h"      overwrite="true"  derived="true" />
      <copy source="Startup_Code/rtc.cpp"        target="Startup_Code/rtc.cpp"       overwrite="true"  derived="true" />
      <copy source="Snippets/rtc-example.cpp"    target="Snippets/rtc-example.cpp"   overwrite="true"  derived="true" />
   </projectActionList>

   <template><![CDATA[
      \t/**
      \t * Get RTC clock frequency (internal, not masked by RTC_CR_CLKO)
      \t *
      \t * @return Clock frequency as uint32_t
      \t */
      \tstatic uint32_t getInternalClock() {
      \t   return (rtc->CR&RTC_CR_OSCE_MASK)?osc_input_freq:0;
      \t}

      \t/**
      \t * Get RTC clock frequency (external, masked by RTC_CR_CLKO)
      \t *
      \t * @return Clock frequency as uint32_t
      \t */
      \tstatic uint32_t getExternalClock() {
      \t   return (rtc->CR&RTC_CR_CLKO_MASK)?0:getInternalClock();
      \t}
      \t\n
   ]]></template>


</fragment>
