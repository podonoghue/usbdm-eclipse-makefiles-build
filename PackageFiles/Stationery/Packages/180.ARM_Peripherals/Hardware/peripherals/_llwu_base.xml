<?xml version="1.0" encoding="UTF-8"
?>
<!DOCTYPE fragment SYSTEM "_menu.dtd" >
<!-- _llwu_base.xml -->

<fragment xmlns:xi="http://www.w3.org/2001/XInclude">

   <xi:include href="_default_instance.xml"/>
 
   <template namespace="usbdm" ><![CDATA[
      \t/**
      \t * LLWU peripheral wake-up mode
      \t */
      \tenum LlwuPeripheralMode {
      \t   LlwuPeripheralMode_Disabled = false, //!< Wake-up by peripheral disabled
      \t   LlwuPeripheralMode_Enabled  = true,  //!< Wake-up by peripheral enabled
      \t};
      \t\n\n
   ]]></template>

   <template namespace="usbdm" ><![CDATA[
      \t/**
      \t * Wake-up pin control
      \t *
      \t * Enables and configures the edge detection for the wakeup pin
      \t */
      \tenum LlwuPinMode {
      \t   LlwuPinMode_Disabled    = (LLWU_PE1_WUPE0(0)|LLWU_PE1_WUPE1(0)|LLWU_PE1_WUPE2(0)|LLWU_PE1_WUPE3(0)), ///< Wake-up pin disabled
      \t   LlwuPinMode_RisingEdge  = (LLWU_PE1_WUPE0(1)|LLWU_PE1_WUPE1(1)|LLWU_PE1_WUPE2(1)|LLWU_PE1_WUPE3(1)), ///< Wake-up on pin rising edge
      \t   LlwuPinMode_FallingEdge = (LLWU_PE1_WUPE0(2)|LLWU_PE1_WUPE1(2)|LLWU_PE1_WUPE2(2)|LLWU_PE1_WUPE3(2)), ///< Wake-up on pin falling edge
      \t   LlwuPinMode_EitherEdge  = (LLWU_PE1_WUPE0(3)|LLWU_PE1_WUPE1(3)|LLWU_PE1_WUPE2(3)|LLWU_PE1_WUPE3(3)), ///< Wake-up on pin either edge
      \t};\n\n
   ]]></template>

   <category name="Pin sources" description="Wakeups from pins">  
      <for keys  ="r,   p  " 
           values="1,   0  ;
                   1,   1  ;
                   1,   2  ;
                   1,   3  ;
                   2,   4  ;
                   2,   5  ;
                   2,   6  ;
                   2,   7  ;
                   3,   8  ;
                   3,   9  ;
                   3,   10 ;
                   3,   11 ;
                   4,   12 ;
                   4,   13 ;
                   4,   14 ;
                   4,   15 ;
                   5,   16 ;
                   5,   17 ;
                   5,   18 ;
                   5,   19 ;
                   6,   20 ;
                   6,   21 ;
                   6,   22 ;
                   6,   23 ;
                   7,   24 ;
                   7,   25 ;
                   7,   26 ;
                   7,   27 ;
                   8,   28 ;
                   8,   29 ;
                   8,   30 ;
                   8,   31 "
           >
         <choiceOption key="llwu_pe%(r)_wupe%(p)" condition="llwu_pe%(r)_present"
            description="Unused input %(p)"
            valueFormat="(LLWU_PE%(r)_WUPE%(p)_MASK&amp;(%s))"
            toolTip="Enables and configures the edge detection for the wakeup pin">
            <choice name="Wake-up pin disabled"        value="LlwuPinMode_Disabled"     isDefault="true" /> 
            <choice name="Wake-up on pin rising edge"  value="LlwuPinMode_RisingEdge"   /> 
            <choice name="Wake-up on pin falling edge" value="LlwuPinMode_FallingEdge"  /> 
            <choice name="Wake-up on pin either edge"  value="LlwuPinMode_EitherEdge"   />
         </choiceOption>
      </for>
   
      <for keys  ="r,   p0,  p1,  p2,  p3  " 
           values="1,    0,   1,   2,   3;
                   2,    4,   5,   6,   7;
                   3,    8,   9,  10,  11;
                   4,   12,  13,  14,  15;
                   5,   16,  17,  18,  19;
                   6,   20,  21,  22,  23;
                   7,   24,  25,  26,  27;
                   8,   28,  29,  30,  31"
           >
         <initialValueTemplate 
            variables="
               llwu_pe%(r)_wupe%(p0),
               llwu_pe%(r)_wupe%(p1),
               llwu_pe%(r)_wupe%(p2),
               llwu_pe%(r)_wupe%(p3)"     
         ><![CDATA[
            \t/// LLWU Pin Enable register %(r)
            \tstatic constexpr uint8_t pe%(r) = %expression\n\n
         ]]></initialValueTemplate>
      </for>
   
      <for keys="r,p" values="1,0;2,4;3,8;4,12;5,16;6,20;7,24;8,28;"  > 
         <template key="llwu_base_init" namespace="all" condition="llwu_pe%(r)_wupe%(p)" ><![CDATA[
            \t   llwu->PE%(r)   = Info::pe%(r);\n
         ]]></template>
      </for>
   
      <choiceOption key="llwu_filt_filte"  hidden="true"
         enumStem="LlwuFilterPinMode"
         description="Wakup On External Pin with Digital Filter"  
         toolTip="Controls the digital filter options for the external pin detect">
         <choice name="Wake-up disabled"                  enum="Disabled"     value="0" isDefault="true" />
         <choice name="Wake-up on filtered rising edge"   enum="RisingEdge"   value="1" />
         <choice name="Wake-up on filtered falling edge"  enum="FallingEdge"  value="2" />
         <choice name="Wake-up on either filtered edge"   enum="EitherEdge"   value="3" />
      </choiceOption>   
      
      <for keys="n" values="1;2;3;4">
         <choiceOption key="llwu_filt%(n)_filte"   derivedFrom="llwu_filt_filte"   condition="llwu_filt%(n)_present" />
         <choiceOption key="llwu_filt%(n)_filtsel"  condition="llwu_filt%(n)_present"
            description="Filter %(n) Pin Select" 
            toolTip="Selects 1 of the external signals to be muxed into the filter">
            <choice name="" value="" enum="dummy" />
         </choiceOption>   
   
         <initialValueTemplate 
            variables="
               llwu_filt%(n)_filte,
               llwu_filt%(n)_filtsel"     
         ><![CDATA[
            \t/// Pin Filter %(n) register
            \tstatic constexpr uint8_t filt%(n) = %expression\n\n
         ]]></initialValueTemplate>
      
         <template key="llwu_base_init" namespace="all"  condition="llwu_filt%(n)_present" ><![CDATA[
            \t   llwu->FILT%(n) = Info::filt%(n)|LLWU_FILT_FILTF_MASK;\n
         ]]></template>
      </for>
   </category>

   <template key="llwu_base_methods" namespace="all"  ><![CDATA[
      \t/**
      \t * Class used to do initialisation of LLWU
      \t *
      \t * This class has a templated constructor that accepts various values:
      \t * - llwuPeripheral,                            - Peripheral to enable as wake-up source
      \t * - llwuPin, llwuPinMode,                      - Pin to enable as direct wake-up source
      \t * - llwuFilterNum, llwuPin, llwuFilterPinMode, - Pin to enable as filtered wake-up source
      \t *
      \t * @note This constructor may be used to create a const instance in ROM
      \t *
      \t * Example:
      \t * @code
      \t * const Llwu::LlwuInit llwuInit {
      \t *    // Pins
      \t *    LlwuPin_Pta4,  LlwuPinMode_FallingEdge,
      \t *    LlwuPin_Pta13, LlwuPinMode_EitherEdge,
      \t *    LlwuPin_Ptd4,  LlwuPinMode_RisingEdge,
      \t *
      \t *    // Filtered Pins
      \t *    LlwuFilterNum_0, LlwuPin_Pta4, LlwuFilterPinMode_EitherEdge,
      \t *    LlwuFilterNum_1, LlwuPin_Ptc3, LlwuFilterPinMode_RisingEdge,
      \t *
      \t *    // Peripherals
      \t *    LlwuPeripheral_RtcAlarm,
      \t *    LlwuPeripheral_Lptmr0,
      \t *
      \t *    // Reset
      \t *    LlwuResetWakeup_Enabled, LlwuResetFilter_Enabled
      \t * };
      \t *
      \t * // Initialise LLWU from values specified above
      \t * llwuInit.initialise()
      \t * @endcode
      \t */
      \tclass LlwuInit {
      \t
      \tpublic:
      \t   /**
      \t    * Constructor
      \t    */
      \t   constexpr LlwuInit() {
      \t   }
      \t           
      \tprivate:
      \t   static constexpr uint8_t masks[] =
      \t      {LLWU_PE1_WUPE0_MASK, LLWU_PE1_WUPE1_MASK, LLWU_PE1_WUPE2_MASK, LLWU_PE1_WUPE3_MASK, };
      \t\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all" condition="llwu_me_wume0" ><![CDATA[
      \t   uint8_t me      = 0;\n
   ]]></template>

   <template key="llwu_base_methods" namespace="all" condition="llwu_rst_llrste" ><![CDATA[
      \t   uint8_t rst     = 0;\n
   ]]></template>
   
   <if condition="llwu_pe5_wupe16" >
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t pe[8]   = {0};\n
      ]]></template>
   <else_if condition="llwu_pe4_wupe12" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t pe[4]   = {0};\n
      ]]></template>
   <else_if condition="llwu_pe3_wupe8" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t pe[3]   = {0};\n
      ]]></template>
   <else_if condition="llwu_pe2_wupe4" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t pe[2]   = {0};\n
      ]]></template>
   <else_if condition="llwu_pe1_wupe0" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t pe[1]   = {0};\n
      ]]></template>
   </if>

   <if condition="llwu_filt4_filte" >
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t filt[4] = {0};\n
      ]]></template>
   <else_if condition="llwu_filt3_filte" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t filt[3] = {0};\n
      ]]></template>
   <else_if condition="llwu_filt2_filte" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t filt[2] = {0};\n
      ]]></template>
   <else_if condition="llwu_filt1_filte" />
      <template key="llwu_base_methods" namespace="all" ><![CDATA[
         \t   uint8_t filt[1] = {0};\n
      ]]></template>
   </if>
   
   <template key="llwu_base_methods" namespace="all" ><![CDATA[
      \t
      \tpublic:\n
   ]]></template>
   
   <template key="llwu_base_methods" namespace="all" condition="llwu_me_wume0" ><![CDATA[
      \t   /**
      \t    * Constructor for peripheral source
      \t    *
      \t    * @tparam Types
      \t    * @param rest
      \t    *
      \t    * @param llwuPeripheral  Peripheral to enable as wake-up source
      \t    */
      \t   template <typename... Types>
      \t   constexpr LlwuInit(LlwuPeripheral llwuPeripheral, Types... rest) : LlwuInit(rest...) {
      \t   
      \t      me |= llwuPeripheral;
      \t   }
      \t\n
   ]]></template>
   
   <template key="llwu_base_methods" namespace="all" condition="llwu_filt1_filte" ><![CDATA[
      \t   /**
      \t    * Constructor for filtered pin source
      \t    *
      \t    * @tparam Types
      \t    * @param rest
      \t    *
      \t    * @param llwuFilterNum       Filter to use
      \t    * @param llwuPin             Peripheral to enable as wake-up source
      \t    * @param llwuFilterPinMode   Sensitivity of pin
      \t    */
      \t   template <typename... Types>
      \t   constexpr LlwuInit(
      \t         LlwuFilterNum     llwuFilterNum,
      \t         LlwuPin           llwuPin,
      \t         LlwuFilterPinMode llwuFilterPinMode,
      \t         Types... rest) : LlwuInit(rest...) {
      \t   
      \t      filt[llwuFilterNum] = llwuPin|llwuFilterPinMode;
      \t   }
      \t\n
   ]]></template>
   
   <template key="llwu_base_methods" namespace="all" condition="llwu_pe1_wupe0" ><![CDATA[
      \t   /**
      \t    * Constructor for unfiltered pin source
      \t    *
      \t    * @tparam Types
      \t    * @param rest
      \t    *
      \t    * @param llwuPin       Peripheral to enable as wake-up source
      \t    * @param llwuPinMode   Sensitivity of pin
      \t    */
      \t   template <typename... Types>
      \t   constexpr LlwuInit(LlwuPin llwuPin, LlwuPinMode llwuPinMode, Types... rest) : LlwuInit(rest...) {
      \t   
      \t      const int      index = llwuPin>>2;
      \t      const uint8_t  value = llwuPinMode & masks[llwuPin&3];
      \t   
      \t      pe[index] |= value;
      \t   }
      \t\n
   ]]></template>

   <template key="llwu_base_methods" namespace="all" condition="llwu_rst_llrste" ><![CDATA[
      \t   /**
      \t    * Constructor for Reset as wake-up source
      \t    *
      \t    * @tparam Types
      \t    * @param rest
      \t    *
      \t    * @param llwuResetWakeup  Enable/Disable Reset source
      \t    * @param llwuResetFilter  Enable/Disable Reset pin filter
      \t    */
      \t   template <typename... Types>
      \t   constexpr LlwuInit(LlwuResetWakeup llwuResetWakeup, LlwuResetFilter llwuResetFilter, Types... rest) : LlwuInit(rest...) {
      \t   
      \t      rst = llwuResetWakeup|llwuResetFilter;
      \t   }
      \t\n
   ]]></template>

   <template key="llwu_base_methods" namespace="all"  ><![CDATA[
      \t   /**
      \t    * Initialise LLWU from values specified in constructor
      \t    */
      \t   void initialise() const {\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all" condition="llwu_pe1_wupe0" ><![CDATA[
      \t      llwu->PE[0]   = pe[0];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_pe2_wupe4" ><![CDATA[
      \t      llwu->PE[1]   = pe[1];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_pe3_wupe8" ><![CDATA[
      \t      llwu->PE[2]   = pe[2];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_pe4_wupe12" ><![CDATA[
      \t      llwu->PE[3]   = pe[3];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_pe5_wupe16" ><![CDATA[
      \t      llwu->PE[4]   = pe[4];
      \t      llwu->PE[5]   = pe[5];
      \t      llwu->PE[6]   = pe[6];
      \t      llwu->PE[7]   = pe[7];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_me_wume0" ><![CDATA[
      \t
      \t      llwu->ME      = me;\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all" condition="llwu_rst_llrste" ><![CDATA[
      \t
      \t      llwu->RST     = rst;
   ]]></template>
   
   <template key="llwu_base_methods" namespace="all"  condition="llwu_filt1_filte" ><![CDATA[
      \t\n
      \t      llwu->FILT[0] = filt[0];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_filt2_filte" ><![CDATA[
      \t      llwu->FILT[1] = filt[1];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_filt3_filte" ><![CDATA[
      \t      llwu->FILT[2] = filt[2];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all"  condition="llwu_filt4_filte" ><![CDATA[
      \t      llwu->FILT[3] = filt[3];\n
   ]]></template>
   <template key="llwu_base_methods" namespace="all" ><![CDATA[
      \t   }\n
   ]]></template>

   <template key="llwu_base_methods" namespace="all" ><![CDATA[
      \t};\n\n
      
   ]]></template>
        
   <template key="declarations" namespace="all"  ><![CDATA[
      \t/**
      \t * Class representing LLWU
      \t */
      \tclass Llwu : public LlwuBase_T<LlwuInfo> {};
   ]]></template>
   
   <xi:include href="_mapPinsOption.xml"/>   
   <xi:include href="_irqOption.xml"/>

   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.LlwuValidate">
   </validate>

   <signals/>

   <projectActionList id = "llwu_files" >
      <copy source="Project_Headers/llwu.h"            target="Project_Headers/llwu.h"            overwrite="true" derived="true" />
      <copy source="Snippets/llwu-example-mk22f.cpp"   target="Snippets/llwu-example-mk22f.cpp"   overwrite="true" derived="true" />
      <copy source="Snippets/llwu-example-mkl25z.cpp"  target="Snippets/llwu-example-mkl25z.cpp"  overwrite="true" derived="true" />
   </projectActionList>
   
</fragment>
