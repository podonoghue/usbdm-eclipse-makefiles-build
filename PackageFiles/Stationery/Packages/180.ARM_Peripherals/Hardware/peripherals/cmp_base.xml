<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fragment SYSTEM "_menu.dtd" >
<!-- cmp_base.xml -->

<fragment xmlns:xi="http://www.w3.org/2001/XInclude">

   <xi:include href="_default_instance.xml"/>

   <template><![CDATA[
      \t//! Pin number in Info table for comparator output if mapped to a pin
      \tstatic constexpr int outputPin  = 8;\n\n
   ]]></template>
   
   <constant key="disable_peripheral" value = "cmp->CR1 = CMP_CR1_EN(0);"  />
   <xi:include href="_mapPinsOption.xml"/>
   
   <choiceOption key="cmp_cr0_filter_cnt" 
      description="Filter Sample Count"
      toolTip="Represents the number of consecutive samples that must agree prior\n
      to the comparator ouput filter accepting a new output state">
      <choice value="0" name="Filter is disabled" />
      <choice value="1" name="1 sample must agree" />
      <choice value="2" name="2 sample must agree" />
      <choice value="3" name="3 sample must agree" />
      <choice value="4" name="4 sample must agree" />
      <choice value="5" name="5 sample must agree" />
      <choice value="6" name="6 sample must agree" />
      <choice value="7" name="7 sample must agree" />
   </choiceOption>

   <choiceOption key="cmp_cr0_hystctr" 
      description="Comparator hard block hysteresis control"
      toolTip="Defines the programmable hysteresis level.\n
      The hysteresis values associated with each level are device specific">
      <choice value="0" name="Level 0" />
      <choice value="1" name="Level 1" />
      <choice value="2" name="Level 2" />
      <choice value="3" name="Level 3" />
   </choiceOption>

   <template><![CDATA[
      \t//! CMP Control Register 0
      \tstatic constexpr uint32_t cr0 =
      \t   CMP_CR0_FILTER_CNT($(cmp_cr0_filter_cnt))     | // Filter Sample Count
      \t   CMP_CR0_HYSTCTR($(cmp_cr0_hystctr));         // Comparator hard block hysteresis control\n\n
   ]]></template>

   <binaryOption key="cmp_cr1_se" 
      description="Sample Enable"
      toolTip="Sampling mode enabled">
      <choice value="0" name="Sampling mode is disabled" />
      <choice value="1" name="Sampling mode is enabled" />
   </binaryOption>

   <binaryOption key="cmp_cr1_we" 
      description="Windowing Enable"
      toolTip="Windowing mode enabled">
      <choice value="0" name="Windowing mode is disabled" />
      <choice value="1" name="Windowing mode is enabled" />
   </binaryOption>

   <binaryOption key="cmp_cr1_trigm" 
      description="Trigger Mode Enable"
      toolTip="CMP and DAC are configured to CMP Trigger mode">
      <choice value="0" name="Trigger mode is disabled" />
      <choice value="1" name="Trigger mode is enabled" />
   </binaryOption>

   <binaryOption key="cmp_cr1_pmode" 
      description="Power Mode Select"
      toolTip="Selects trade-off between speed and power consumption">
      <choice value="0" name="Low-Speed (LS) Comparison mode" />
      <choice value="1" name="High-Speed (HS) Comparison mode" />
   </binaryOption>

   <binaryOption key="cmp_cr1_inv" 
      description="Comparator Invert"
      toolTip="Allows selection of the polarity of the analog comparator function">
      <choice value="0" name="Not inverted" />
      <choice value="1" name="Inverted" />
   </binaryOption>

   <binaryOption key="cmp_cr1_cos" 
      description="Comparator Output Select"
      toolTip="">
      <choice value="0" name="Set the filtered comparator output (CMPO) to equal COUT" />
      <choice value="1" name="Set the unfiltered comparator output (CMPO) to equal COUTA" />
   </binaryOption>

   <binaryOption key="cmp_cr1_ope" 
      description="Comparator Output Pin Enable"
      toolTip="">
      <choice value="0" name="CMPO is not available on CMPO pin" />
      <choice value="1" name="CMPO is available on CMPO pin" />
   </binaryOption>

   <template><![CDATA[
      \t//! CMP Control Register 1
      \tstatic constexpr uint32_t cr1 =
      \t   CMP_CR1_SE($(cmp_cr1_se))    | // Sample Enable
      \t   CMP_CR1_WE($(cmp_cr1_we))    | // Windowing Enable
      \t#if defined(CMP_CR1_TRIGM)
      \t   CMP_CR1_TRIGM($(cmp_cr1_trigm)) | // Trigger Mode Enable
      \t#endif
      \t   CMP_CR1_PMODE($(cmp_cr1_pmode)) | // Power mode Select
      \t   CMP_CR1_INV($(cmp_cr1_inv))   | // Comparator Invert
      \t   CMP_CR1_COS($(cmp_cr1_cos))   | // Comparator Output Select
      \t   CMP_CR1_OPE($(cmp_cr1_ope));    // Comparator Output Pin Enable\n\n
   ]]></template>
      
   <intOption key="cmp_fpr_filt_per"
      description="Filter Sample Period"
      toolTip="Specifies the sampling period, in bus clock cycles, of the comparator output filter"
      value="0" min="0" max="255" />
           
   <template><![CDATA[
      \t//! CMP Filter Period Register
      \tstatic constexpr uint32_t fpr =
      \t   CMP_FPR_FILT_PER($(cmp_fpr_filt_per)); // Filter Sample Period\n\n
   ]]></template>

   <binaryOption key="cmp_scr_dmaen" 
      description="DMA Enable Control"
      toolTip="Enables the DMA transfer triggered from the CMP module\n(If DMA supported by device)\n
         When this field is set, a DMA request is asserted when CFR or CFF is set">
      <choice value="0" name="Disabled" />
      <choice value="1" name="Enabled" />
   </binaryOption>

   <binaryOption key="cmp_scr_ier" 
      description="Comparator Interrupt Enable Rising"
      toolTip="Enables the CFR interrupt from the CMP.\n
         When this field is set, an interrupt will be asserted when CFR is set">
      <choice value="0" name="Disabled" />
      <choice value="1" name="Enabled" />
   </binaryOption>

   <binaryOption key="cmp_scr_ief" 
      description="Comparator Interrupt Enable Falling"
      toolTip="Enables the CFF interrupt from the CMP\n
         When this field is set, an interrupt will be asserted when CFF is set">
      <choice value="0" name="Disabled" />
      <choice value="1" name="Enabled" />
   </binaryOption>

   <template><![CDATA[
      \t//! CMP Status and Control Register
      \tstatic constexpr uint32_t scr =
      \t#ifdef CMP_SCR_DMAEN
      \t   CMP_SCR_DMAEN($(cmp_scr_dmaen:0)) | // DMA Enable Control
      \t#endif
      \t   CMP_SCR_IER($(cmp_scr_ier)) | // Comparator Interrupt Enable Rising
      \t   CMP_SCR_IEF($(cmp_scr_ief));  // Comparator Interrupt Enable Falling\n\n
   ]]></template>

   <binaryOption key="cmp_daccr_vrsel" 
      description="DAC Reference Voltage Select"
      toolTip="Supply Voltage Reference Source Select">
      <choice value="0" name="Vin1 (Vref_OUT)" />
      <choice value="1" name="Vin2 (Vdd)" />
   </binaryOption>

   <template><![CDATA[
      \t//! DAC Control Register
      \tstatic constexpr uint32_t daccr =
      \t   CMP_DACCR_VRSEL($(cmp_daccr_vrsel)); // Supply Voltage Reference Source Select\n\n
   ]]></template>

   <template key="/CMP/declarations" namespace="all"  ><![CDATA[
   \t/**
   \t * Class representing $(_name)
   \t */
   \tclass Cmp$(_instance) : public CmpBase_T<Cmp$(_instance)Info> {
   \t
   \tpublic:
   \t   /**
   \t    * Select CMP$(_instance) inputs
   \t    */
   \t   enum Input {
   \t      // Mapped inputs
   \t      Input_0          = 0, //!< CMP$(_instance) input 0
   \t      Input_1          = 1, //!< CMP$(_instance) input 1
   \t      Input_2          = 2, //!< CMP$(_instance) input 2
   \t      Input_3          = 3, //!< CMP$(_instance) input 3
   \t      Input_4          = 4, //!< CMP$(_instance) input 4
   \t      Input_5          = 5, //!< CMP$(_instance) input 5
   \t      Input_6          = 6, //!< CMP$(_instance) input 6
   \t      Input_7          = 7, //!< CMP$(_instance) input 7
   \t   
           $(/CMP$(_instance)/InputMapping:   // None Found)
   \t   };
   \t
   \t   /**
   \t    * Configure Comparator input sources
   \t    *
   \t    * @param[in]  positiveInput (0..7) (7 => DAC)
   \t    * @param[in]  negativeInput (0..7) (7 => DAC)
   \t    */
   \t   static __attribute__((always_inline)) void selectInputs(Input positiveInput, Input negativeInput) {
   \t      CmpBase_T::selectInputs((unsigned)positiveInput, (unsigned)negativeInput);
   \t   }
   \t
   \t   template <class T>
   \t   static __attribute__((always_inline)) void selectInputs(Input input, T &) {
   \t      CmpBase_T::selectInputs((unsigned)input, (unsigned)T::pinNum);
   \t   }
   \t
   \t   template <class T>
   \t   static __attribute__((always_inline)) void selectInputs(T &, Input input) {
   \t      CmpBase_T::selectInputs((unsigned)T::pinNum, (unsigned)input);
   \t   }
   \t
   \t   template <class T1, class T2>
   \t   static __attribute__((always_inline)) void selectInputs(T1 &, T2&) {
   \t      CmpBase_T::selectInputs((unsigned)T1::pinNum, (unsigned)T2::pinNum);
   \t   }
   \t
   \t   /**
   \t    * Class representing a Comparator pin
   \t    *
   \t    * @tparam cmpInput Number of comparator input (0-7) for associated pin.
   \t    */
   \t   template<int cmpInput>
   \t   class Pin {
   \t      using Pcr = PcrTable_T<Cmp$(_instance)Info, (Input)cmpInput>;
   \t   public:
   \t      static constexpr Input pinNum = (Input)cmpInput;
   \t
   \t      constexpr Pin() {}
   \t      static void setInput() {
   \t         Pcr::setPCR();
   \t      }
   \t   };
   \t};
   \t
   ]]></template>

   <projectActionList id = "cmp_files" >
      <copy source="Project_Headers/cmp.h"     target="Project_Headers/cmp.h"     overwrite="true"  derived="true" />
      <copy source="Snippets/cmp-example.cpp"  target="Snippets/cmp-example.cpp"  overwrite="true"  derived="true" />
   </projectActionList>
   
   <validate
      class="net.sourceforge.usbdm.deviceEditor.validators.PeripheralValidator">
   </validate>

</fragment>
